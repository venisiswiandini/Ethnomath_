<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ETHNOMATH - Ethnomathematics Twin Shapes</title>
  <script src="https://cdn.tailwindcss.com">
function sendToGoogleSheets(action, data = {}) {
    try {
        const appsActionMap = {
            'quiz_complete': 'submitQuiz',
            'quiz_answer': null,
            'quiz_start': null,
            'slide2_answer': 'submitMaterial',
            'slide3_answer': 'submitMaterial',
            'slide4_answer': 'submitMaterial',
            'material_start': null,
            'memory_game_complete': 'submitMemory',
            'memory_game_start': null
        };

        const base = {
            action: action,
            sessionId: typeof sessionId !== 'undefined' ? sessionId : '',
            playerName: typeof playerName !== 'undefined' ? playerName : 'Anonymous',
            device: typeof userDevice !== 'undefined' ? userDevice : '',
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            ...data
        };

        const mapped = appsActionMap[action];
        let finalPayload = base;

        if (mapped === 'submitQuiz') {
            finalPayload = {
                action: 'submitQuiz',
                name: base.playerName,
                score: data.finalScore || data.score || 0,
                answers: JSON.stringify(data.answers || data.quizAnswers || []),
                timeSeconds: data.timeUsed || data.timeSeconds || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMaterial') {
            finalPayload = {
                action: 'submitMaterial',
                name: base.playerName,
                slide: data.slide || data.slideNumber || '',
                answer: data.answer || data.answerText || '',
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMemory') {
            finalPayload = {
                action: 'submitMemory',
                name: base.playerName,
                time: data.time || data.timeString || '',
                timeSeconds: data.timeSeconds || data.timeSecondsPlayed || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        }

        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalPayload)
        })
        .catch(err => {
            const params = new URLSearchParams(finalPayload).toString();
            new Image().src = `${APPS_SCRIPT_URL}?${params}`;
        });

    } catch (err) {
        console.error('sendToGoogleSheets error:', err);
    }
}


// RESET DATA button handler
const resetBtn = document.getElementById('resetDashboardBtn');
resetBtn && resetBtn.addEventListener('click', async () => {
  if (!confirm('âš ï¸ Yakin ingin menghapus SEMUA data di Google Sheets? Tindakan ini tidak bisa dibatalkan.')) return;
  setDashboardStatus('Resetting...');
  showMessage('Menghapus semua data...');
  try {
    const res = await fetch(APPS_SCRIPT_URL + '?action=resetData', { method: 'GET' });
    const json = await res.json();
    if (json.ok) {
      showMessage('âœ… Data berhasil dihapus.', 'success');
      setDashboardStatus('Reset OK');
      console.log('âœ… Semua data dihapus:', json);
      await loadAllTabs();
    } else {
      showMessage('âŒ Gagal menghapus data: ' + (json.msg || json.error || 'Unknown error'), 'error');
      setDashboardStatus('Reset failed');
      console.error('Reset failed', json);
    }
  } catch (err) {
    console.error('Reset error', err);
    showMessage('âŒ Terjadi kesalahan: ' + err.message, 'error');
    setDashboardStatus('Error');
  }
});

</script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* CRITICAL FIX: Make ALL buttons clickable */
        * {
            box-sizing: border-box;
        }
        
        button, 
        .quiz-option,
        .memory-card,
        .slide-indicator,
        .dashboard-tab,
        .neon-button,
        [onclick] {
            pointer-events: auto !important;
            cursor: pointer !important;
            z-index: 99999 !important;
            position: relative !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -webkit-tap-highlight-color: transparent !important;
            touch-action: manipulation !important;
            outline: none !important;
            min-height: 44px !important;
            min-width: 44px !important;
            border: 2px solid transparent !important;
        }
        
        /* Remove ALL pseudo-elements that could block clicks */
        *::before,
        *::after {
            pointer-events: none !important;
            z-index: -1 !important;
        }

        /* Enhanced Glass Card Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Holographic Effect */
        .holographic {
            background: linear-gradient(45deg, rgba(255, 0, 150, 0.1), rgba(0, 255, 255, 0.1), rgba(255, 255, 0, 0.1), rgba(255, 0, 150, 0.1));
            background-size: 400% 400%;
            animation: holographic 4s ease-in-out infinite;
        }

        @keyframes holographic {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Enhanced Bounce-in-3D Animation */
        .bounce-in-3d {
            animation: bounceIn3D 1s ease-out;
        }

        @keyframes bounceIn3D {
            0% {
                transform: scale3d(0.3, 0.3, 0.3) rotateX(20deg) rotateY(20deg);
                opacity: 0;
            }
            20% {
                transform: scale3d(1.1, 1.1, 1.1) rotateX(-10deg) rotateY(-10deg);
            }
            40% {
                transform: scale3d(0.9, 0.9, 0.9) rotateX(5deg) rotateY(5deg);
            }
            60% {
                transform: scale3d(1.03, 1.03, 1.03) rotateX(-2deg) rotateY(-2deg);
                opacity: 1;
            }
            80% {
                transform: scale3d(0.97, 0.97, 0.97) rotateX(1deg) rotateY(1deg);
            }
            100% {
                transform: scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg);
                opacity: 1;
            }
        }

        /* Enhanced Card Hover Effect */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced Slide Animations */
        .slide-in-left {
            animation: slideInLeft 0.8s ease-out;
        }

        .slide-in-right {
            animation: slideInRight 0.8s ease-out;
        }

        .slide-in-up {
            animation: slideInUp 0.8s ease-out;
        }

        .slide-in-down {
            animation: slideInDown 0.8s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Enhanced Background */
        body {
            background: url('https://i.imgur.com/tSUqoTm.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Background overlay for better readability */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -100 !important;
            pointer-events: none !important;
        }

        /* Enhanced Progress Bar */
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A, #CDDC39);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        /* Glass Card Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }

        /* Neon Button */
        .neon-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 25%, #FF8C00 50%, #FF6347 75%, #FF4500 100%);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9);
            border: 3px solid rgba(255, 215, 0, 0.6);
            color: black;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .neon-button:hover {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 25%, #FF6347 50%, #FF4500 75%, #DC143C 100%);
            transform: scale(1.05);
        }

        /* Game Title */
        .game-title {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Floating Animation */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Quiz Option Styles */
        .quiz-option {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            border: 3px solid transparent !important;
            border-radius: 20px;
            padding: 20px 25px;
            margin: 12px 0;
            cursor: pointer !important;
            transition: all 0.4s ease;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            line-height: 1.5;
            z-index: 99999 !important;
            pointer-events: auto !important;
            display: block !important;
            width: 100%;
            text-align: left;
        }

        .quiz-option:hover {
            background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
            border: 3px solid #3B82F6 !important;
            transform: translateX(15px) scale(1.02);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.3);
        }

        .quiz-option.selected {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 50%, #EC4899 100%);
            color: white;
            border: 3px solid #1D4ED8 !important;
            transform: translateX(10px) scale(1.05);
        }

        .quiz-option.correct {
            background: linear-gradient(135deg, #10B981 0%, #059669 50%, #047857 100%);
            color: white;
            border: 3px solid #059669 !important;
        }

        .quiz-option.incorrect {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 50%, #B91C1C 100%);
            color: white;
            border: 3px solid #DC2626 !important;
        }

        /* Memory Card Styles */
        .memory-game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        .memory-card {
            aspect-ratio: 1;
            border-radius: 15px;
            cursor: pointer !important;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative !important;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background: #f8f9fa;
            padding: 4px;
            z-index: 99999 !important;
            pointer-events: auto !important;
        }

        .memory-card:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #10B981, #059669);
            transform: scale(0.95);
        }

        /* Slide Indicators */
        .slide-indicator {
            transition: all 0.3s ease;
            z-index: 99999 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative !important;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #9CA3AF;
        }
        
        .slide-indicator.active {
            background-color: #3B82F6 !important;
            transform: scale(1.2);
        }

        .slide-indicator:hover:not(.disabled) {
            transform: scale(1.1);
        }

        .slide-indicator.disabled {
            background-color: #D1D5DB !important;
            cursor: not-allowed !important;
            opacity: 0.5 !important;
        }

        .slide-indicator.disabled:hover {
            transform: none !important;
        }

        /* Dashboard Tab Styles */
        .dashboard-tab {
            transition: all 0.3s ease;
            z-index: 99999 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative !important;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            margin: 4px;
        }
        
        .dashboard-tab.active {
            background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%) !important;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        /* Comprehensive Mobile Responsive Design */
        @media (max-width: 768px) {
            /* Base mobile styles */
            body {
                font-size: 16px;
                line-height: 1.5;
            }
            
            /* Container and padding adjustments */
            .glass-card {
                margin: 8px;
                padding: 16px !important;
                border-radius: 20px;
            }
            
            .max-w-4xl, .max-w-6xl, .max-w-7xl {
                max-width: 100% !important;
                margin: 0 8px !important;
            }
            
            /* Typography scaling */
            .text-6xl, .text-8xl {
                font-size: 3.5rem !important;
            }
            
            .text-4xl, .text-5xl {
                font-size: 2.5rem !important;
            }
            
            .text-3xl {
                font-size: 1.8rem !important;
            }
            
            .text-2xl {
                font-size: 1.5rem !important;
            }
            
            .text-xl {
                font-size: 1.3rem !important;
            }
            
            .text-lg {
                font-size: 1.2rem !important;
            }
            
            .text-base {
                font-size: 1.1rem !important;
            }
            
            .text-sm {
                font-size: 1rem !important;
            }
            
            .text-xs {
                font-size: 0.9rem !important;
            }
            
            /* Button improvements */
            button, .neon-button {
                min-height: 52px !important;
                padding: 14px 18px !important;
                font-size: 16px !important;
                border-radius: 12px !important;
                margin: 4px 0 !important;
            }
            
            .neon-button {
                padding: 18px 24px !important;
                font-size: 18px !important;
            }
            
            /* Quiz options mobile optimization */
            .quiz-option {
                padding: 18px 22px !important;
                font-size: 17px !important;
                margin: 10px 0 !important;
                border-radius: 15px !important;
                line-height: 1.5 !important;
                min-height: 70px !important;
                display: flex !important;
                align-items: center !important;
            }
            
            /* Memory game mobile optimization */
            .memory-game-board {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 8px !important;
                padding: 0 8px !important;
                max-width: 100% !important;
            }
            
            .memory-card {
                min-height: 80px !important;
                border-radius: 12px !important;
                aspect-ratio: 1 !important;
            }
            
            /* Navigation improvements */
            .flex.justify-between {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            .flex.space-x-3, .flex.space-x-4, .flex.space-x-8 {
                flex-direction: column !important;
                gap: 8px !important;
                width: 100% !important;
            }
            
            .flex.space-x-3 > *, .flex.space-x-4 > *, .flex.space-x-8 > * {
                margin: 0 !important;
                width: 100% !important;
            }
            
            /* Dashboard mobile optimization */
            .dashboard-tab {
                padding: 12px 18px !important;
                font-size: 15px !important;
                margin: 3px !important;
                border-radius: 20px !important;
            }
            
            .overflow-x-auto {
                font-size: 14px !important;
            }
            
            .overflow-x-auto table {
                min-width: 600px !important;
            }
            
            .overflow-x-auto th, .overflow-x-auto td {
                padding: 10px 8px !important;
                font-size: 13px !important;
            }
            
            /* Grid layouts mobile */
            .grid.grid-cols-2 {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .grid.grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* Form inputs mobile */
            input, textarea {
                font-size: 18px !important;
                padding: 18px !important;
                border-radius: 12px !important;
            }
            
            /* Modal improvements */
            .fixed.inset-0 > div {
                margin: 16px !important;
                max-width: calc(100vw - 32px) !important;
                max-height: calc(100vh - 32px) !important;
                overflow-y: auto !important;
            }
            
            /* Image scaling */
            img {
                max-width: 100% !important;
                height: auto !important;
            }
            
            .max-h-48, .max-h-64 {
                max-height: 200px !important;
            }
            
            .max-h-32 {
                max-height: 120px !important;
            }
            
            /* Slide indicators mobile */
            .slide-indicator {
                width: 16px !important;
                height: 16px !important;
                margin: 0 4px !important;
            }
            
            /* Stats display mobile */
            .flex.justify-center.space-x-8 {
                flex-direction: row !important;
                justify-content: space-around !important;
                gap: 16px !important;
            }
            
            .flex.justify-center.space-x-8 > div {
                flex: 1 !important;
                text-align: center !important;
            }
            
            /* Audio and host buttons mobile positioning */
            #audioButton {
                top: 8px !important;
                right: 8px !important;
                width: 48px !important;
                height: 48px !important;
                min-width: 48px !important;
                min-height: 48px !important;
                max-width: 48px !important;
                max-height: 48px !important;
                padding: 10px !important;
            }
            
            #audioButton svg {
                width: 20px !important;
                height: 20px !important;
            }
            
            #hostLoginBtn {
                bottom: 8px !important;
                left: 8px !important;
                width: 48px !important;
                height: 48px !important;
                min-width: 48px !important;
                min-height: 48px !important;
                max-width: 48px !important;
                max-height: 48px !important;
                padding: 10px !important;
            }
            
            #hostLoginBtn svg {
                width: 20px !important;
                height: 20px !important;
            }
            
            /* Material slide content mobile */
            .flex.flex-col.lg\\:flex-row {
                flex-direction: column !important;
            }
            
            .w-full.lg\\:w-1\\/2 {
                width: 100% !important;
                margin-bottom: 16px !important;
            }
            
            /* Quiz content mobile */
            #quizImageContainer, #quizQuestionImageContainer {
                padding: 12px !important;
            }
            
            /* Progress and timer mobile */
            .text-center.bg-gradient-to-r {
                padding: 8px 12px !important;
                font-size: 14px !important;
            }
            
            /* Feature cards mobile */
            .grid.grid-cols-2.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }
            
            /* Dashboard tabs mobile */
            .flex.flex-wrap.justify-center {
                flex-wrap: wrap !important;
                gap: 4px !important;
            }
            
            /* Table responsive improvements */
            .border-collapse {
                display: block !important;
                overflow-x: auto !important;
                white-space: nowrap !important;
            }
            
            /* Notification positioning */
            .fixed.top-4.right-4 {
                top: 8px !important;
                right: 8px !important;
                left: 8px !important;
                right: 8px !important;
                width: auto !important;
            }
        }
        
        /* Extra small devices (phones in portrait) */
        @media (max-width: 480px) {
            body {
                font-size: 17px !important;
                line-height: 1.6 !important;
            }
            
            .glass-card {
                margin: 4px !important;
                padding: 14px !important;
                border-radius: 16px !important;
            }
            
            .text-3xl {
                font-size: 1.6rem !important;
            }
            
            .text-2xl {
                font-size: 1.4rem !important;
            }
            
            .text-xl {
                font-size: 1.25rem !important;
            }
            
            .text-lg {
                font-size: 1.15rem !important;
            }
            
            .text-base {
                font-size: 1.05rem !important;
            }
            
            .text-sm {
                font-size: 0.95rem !important;
            }
            
            .quiz-option {
                padding: 16px 18px !important;
                font-size: 16px !important;
                min-height: 65px !important;
            }
            
            .memory-game-board {
                gap: 8px !important;
            }
            
            .memory-card {
                min-height: 75px !important;
            }
            
            button, .neon-button {
                min-height: 48px !important;
                padding: 12px 16px !important;
                font-size: 15px !important;
            }
            
            .dashboard-tab {
                padding: 10px 14px !important;
                font-size: 14px !important;
            }
            
            .overflow-x-auto th, .overflow-x-auto td {
                padding: 8px 6px !important;
                font-size: 12px !important;
            }
        }
        
        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .min-h-screen {
                min-height: 100vh !important;
                padding: 8px !important;
            }
            
            .text-6xl, .text-8xl {
                font-size: 2.5rem !important;
            }
            
            .glass-card {
                padding: 12px !important;
            }
            
            .memory-game-board {
                max-width: 600px !important;
                margin: 0 auto !important;
            }
        }

        /* Remove any potential blocking elements */
        #particles-js,
        .matrix-rain {
            display: none !important;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript">
function sendToGoogleSheets(action, data = {}) {
    try {
        const appsActionMap = {
            'quiz_complete': 'submitQuiz',
            'quiz_answer': null,
            'quiz_start': null,
            'slide2_answer': 'submitMaterial',
            'slide3_answer': 'submitMaterial',
            'slide4_answer': 'submitMaterial',
            'material_start': null,
            'memory_game_complete': 'submitMemory',
            'memory_game_start': null
        };

        const base = {
            action: action,
            sessionId: typeof sessionId !== 'undefined' ? sessionId : '',
            playerName: typeof playerName !== 'undefined' ? playerName : 'Anonymous',
            device: typeof userDevice !== 'undefined' ? userDevice : '',
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            ...data
        };

        const mapped = appsActionMap[action];
        let finalPayload = base;

        if (mapped === 'submitQuiz') {
            finalPayload = {
                action: 'submitQuiz',
                name: base.playerName,
                score: data.finalScore || data.score || 0,
                answers: JSON.stringify(data.answers || data.quizAnswers || []),
                timeSeconds: data.timeUsed || data.timeSeconds || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMaterial') {
            finalPayload = {
                action: 'submitMaterial',
                name: base.playerName,
                slide: data.slide || data.slideNumber || '',
                answer: data.answer || data.answerText || '',
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMemory') {
            finalPayload = {
                action: 'submitMemory',
                name: base.playerName,
                time: data.time || data.timeString || '',
                timeSeconds: data.timeSeconds || data.timeSecondsPlayed || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        }

        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalPayload)
        })
        .catch(err => {
            const params = new URLSearchParams(finalPayload).toString();
            new Image().src = `${APPS_SCRIPT_URL}?${params}`;
        });

    } catch (err) {
        console.error('sendToGoogleSheets error:', err);
    }
}

</script>
  <script src="/_sdk/element_sdk.js" type="text/javascript">
function sendToGoogleSheets(action, data = {}) {
    try {
        const appsActionMap = {
            'quiz_complete': 'submitQuiz',
            'quiz_answer': null,
            'quiz_start': null,
            'slide2_answer': 'submitMaterial',
            'slide3_answer': 'submitMaterial',
            'slide4_answer': 'submitMaterial',
            'material_start': null,
            'memory_game_complete': 'submitMemory',
            'memory_game_start': null
        };

        const base = {
            action: action,
            sessionId: typeof sessionId !== 'undefined' ? sessionId : '',
            playerName: typeof playerName !== 'undefined' ? playerName : 'Anonymous',
            device: typeof userDevice !== 'undefined' ? userDevice : '',
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            ...data
        };

        const mapped = appsActionMap[action];
        let finalPayload = base;

        if (mapped === 'submitQuiz') {
            finalPayload = {
                action: 'submitQuiz',
                name: base.playerName,
                score: data.finalScore || data.score || 0,
                answers: JSON.stringify(data.answers || data.quizAnswers || []),
                timeSeconds: data.timeUsed || data.timeSeconds || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMaterial') {
            finalPayload = {
                action: 'submitMaterial',
                name: base.playerName,
                slide: data.slide || data.slideNumber || '',
                answer: data.answer || data.answerText || '',
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMemory') {
            finalPayload = {
                action: 'submitMemory',
                name: base.playerName,
                time: data.time || data.timeString || '',
                timeSeconds: data.timeSeconds || data.timeSecondsPlayed || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        }

        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalPayload)
        })
        .catch(err => {
            const params = new URLSearchParams(finalPayload).toString();
            new Image().src = `${APPS_SCRIPT_URL}?${params}`;
        });

    } catch (err) {
        console.error('sendToGoogleSheets error:', err);
    }
}

</script>
 </head>
 <body class="min-h-screen"><!-- Background Music -->
  <audio id="backgroundMusic" loop preload="auto"><source src="https://raw.githubusercontent.com/venisiswiandini/Ethnomath_/refs/heads/main/BS.mp3" type="audio/mpeg">
  </audio><!-- Enhanced Audio Control Button - Top Right --> <button id="audioButton" class="fixed top-4 right-4 z-50 neon-button rounded-full shadow-2xl flex items-center justify-center" style="z-index: 99999 !important; position: fixed !important; width: 56px !important; height: 56px !important; min-width: 56px !important; min-height: 56px !important; max-width: 56px !important; max-height: 56px !important; padding: 12px !important;" onclick="toggleAudio()">
   <svg id="audioIcon" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24" style="width: 24px !important; height: 24px !important;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
   </svg></button> <!-- Connection Status Indicator - Top Right (below audio button) -->
  <div id="connectionStatus" class="fixed top-20 right-4 z-50 bg-white/90 backdrop-blur-sm rounded-full px-3 py-2 shadow-lg border-2 border-gray-200" style="z-index: 99999 !important; position: fixed !important;">
   <div class="flex items-center space-x-2">
    <div id="connectionDot" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div><span id="connectionText" class="text-xs font-bold text-gray-700">Testing...</span>
   </div>
  </div><!-- Host Login Button - Bottom Left (Only visible on home page) --> <button id="hostLoginBtn" class="fixed bottom-4 left-4 z-50 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-full shadow-2xl flex items-center justify-center" style="z-index: 99999 !important; position: fixed !important; width: 56px !important; height: 56px !important; min-width: 56px !important; min-height: 56px !important; max-width: 56px !important; max-height: 56px !important; padding: 12px !important;" onclick="showHostLogin()">
   <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24" style="width: 24px !important; height: 24px !important;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
   </svg></button> <!-- Enhanced Home Page -->
  <div id="homePage" class="min-h-screen flex items-center justify-center p-4">
   <div class="max-w-4xl mx-auto text-center w-full">
    <div class="glass-card rounded-3xl p-8 shadow-2xl bounce-in-3d card-hover holographic">
     <div class="mb-8">
      <div class="text-6xl mb-4 floating">
       ğŸ®ğŸŒˆğŸ“âœ¨
      </div>
      <div class="flex justify-center mb-8">
       <div class="relative group">
        <div class="absolute -inset-6 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 rounded-3xl blur-2xl opacity-30 group-hover:opacity-50 transition-all duration-500 animate-pulse"></div>
        <div class="relative glass-card rounded-3xl p-8 border-2 border-white/20 shadow-2xl glow-effect">
         <div class="text-center bg-gradient-to-r from-yellow-600 to-orange-600 text-white p-8 rounded-2xl"><img src="https://i.imgur.com/sWMWajt.png" alt="ETHNOMATH Twin Shapes by Veni Siswiandini" class="w-full h-auto max-h-96 object-contain rounded-lg mx-auto" onerror="this.src='https://imgur.com/sWMWajt.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“</div><h3 class=\'text-2xl font-bold text-white\'>ETHNOMATH</h3><p class=\'text-lg text-white\'>Twin Shapes by Veni Siswiandini</p>'; }">
         </div>
        </div><!-- Enhanced Floating Elements -->
        <div class="absolute -top-6 -right-6 text-4xl animate-bounce floating" style="animation-delay: 0s;">
         âœ¨
        </div>
        <div class="absolute -bottom-6 -left-6 text-4xl animate-bounce floating" style="animation-delay: 0.5s;">
         ğŸŒŸ
        </div>
        <div class="absolute top-1/2 -left-8 text-3xl animate-bounce floating" style="animation-delay: 1s;">
         â­
        </div>
        <div class="absolute top-1/2 -right-8 text-3xl animate-bounce floating" style="animation-delay: 1.5s;">
         ğŸ’«
        </div>
        <div class="absolute top-1/4 -left-10 text-2xl animate-bounce floating" style="animation-delay: 2s;">
         ğŸ¯
        </div>
        <div class="absolute top-3/4 -right-10 text-2xl animate-bounce floating" style="animation-delay: 2.5s;">
         ğŸ¨
        </div>
       </div>
      </div>
      <div class="text-2xl font-bold mb-6 text-center game-title">
       <div style="font-family: 'Orbitron', monospace; font-weight: 600; font-size: 2.2rem; color: #FFFFFF; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); letter-spacing: 0.3px; margin-bottom: 0.5rem; line-height: 1.3; word-wrap: break-word; overflow-wrap: break-word;">
        Ethnomathematics Twin Shapes
       </div>
       <div style="font-family: 'Orbitron', monospace; font-weight: 600; font-size: 1.2rem; color: #FFFFFF; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); letter-spacing: 0.3px; margin-top: 0.5rem;">
        by Veni Siswiandini
       </div>
      </div>
      <div class="text-3xl mb-6 floating">
       ğŸ¯ğŸªğŸš€ğŸŠ
      </div>
     </div><!-- Enhanced Feature Cards -->
     <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
      <div class="glass-card rounded-2xl p-6 card-hover glow-effect slide-in-left" style="border: 3px solid rgba(59, 130, 246, 0.6); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);">
       <div class="text-5xl floating mb-3">
        ğŸ²
       </div>
       <div class="text-xl text-blue-600 font-bold neon-text">
        Seru &amp;
       </div>
       <div class="text-lg text-white font-bold">
        Menarik!
       </div>
      </div>
      <div class="glass-card rounded-2xl p-6 card-hover glow-effect slide-in-up" style="animation-delay: 0.1s; border: 3px solid rgba(34, 197, 94, 0.6); box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);">
       <div class="text-5xl floating mb-3" style="animation-delay: 0.5s;">
        â°
       </div>
       <div class="text-xl text-green-600 font-bold neon-text">
        Interaktif
       </div>
       <div class="text-lg text-white font-bold">
        Seru!
       </div>
      </div>
      <div class="glass-card rounded-2xl p-6 card-hover glow-effect slide-in-down" style="animation-delay: 0.2s; border: 3px solid rgba(245, 158, 11, 0.6); box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);">
       <div class="text-5xl floating mb-3" style="animation-delay: 1s;">
        ğŸ†
       </div>
       <div class="text-xl text-yellow-600 font-bold neon-text">
        Budaya
       </div>
       <div class="text-lg text-white font-bold">
        Melayu
       </div>
      </div>
      <div class="glass-card rounded-2xl p-6 card-hover glow-effect slide-in-right" style="animation-delay: 0.3s; border: 3px solid rgba(168, 85, 247, 0.6); box-shadow: 0 8px 25px rgba(168, 85, 247, 0.3);">
       <div class="text-5xl floating mb-3" style="animation-delay: 1.5s;">
        ğŸ¨
       </div>
       <div class="text-xl text-purple-600 font-bold neon-text">
        Animasi
       </div>
       <div class="text-lg text-white font-bold">
        Keren!
       </div>
      </div>
     </div><!-- Enhanced Action Buttons -->
     <div class="space-y-6"><button class="w-full neon-button text-black px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg" style="z-index: 99999 !important;" onclick="playSound('click'); showMaterial()"> ğŸ“– Materi Pembelajaran ğŸ“š </button> <button class="w-full bg-gradient-to-r from-green-500 via-teal-500 to-blue-600 hover:from-green-600 hover:via-teal-600 hover:to-blue-700 text-black px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-2xl border-3 border-green-400" style="background: linear-gradient(135deg, #10B981 0%, #14B8A6 50%, #3B82F6 100%); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3); text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9), 1px 1px 2px rgba(255, 255, 255, 0.8), 0 0 6px rgba(255, 255, 255, 0.6); z-index: 99999 !important;" onclick="playSound('click'); showNameInput()"> ğŸš€ Latihan Soal ğŸ® </button> <button class="w-full bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-600 hover:from-pink-600 hover:via-purple-600 hover:to-indigo-700 text-black px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-2xl border-3 border-pink-400" style="background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 50%, #6366F1 100%); box-shadow: 0 10px 30px rgba(236, 72, 153, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3); text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9), 1px 1px 2px rgba(255, 255, 255, 0.8), 0 0 6px rgba(255, 255, 255, 0.6); z-index: 99999 !important;" onclick="playSound('click'); showMemoryGame()"> ğŸ® Cocokin Yuk! ğŸ§© </button>
     </div><!-- Enhanced Footer -->
     <div class="mt-8 text-center">
      <div class="text-lg font-bold mb-4" style="color: #000000; text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9), 1px 1px 2px rgba(255, 255, 255, 0.8), 0 0 6px rgba(255, 255, 255, 0.6);">
       ğŸŒŸ Belajar Matematika Jadi Menyenangkan! ğŸŒŸ
      </div>
      <div class="flex justify-center space-x-3 text-3xl"><span class="animate-bounce floating">ğŸ‰</span> <span class="animate-bounce floating" style="animation-delay: 0.1s;">ğŸŠ</span> <span class="animate-bounce floating" style="animation-delay: 0.2s;">ğŸˆ</span> <span class="animate-bounce floating" style="animation-delay: 0.3s;">ğŸ</span> <span class="animate-bounce floating" style="animation-delay: 0.4s;">ğŸª</span>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Halaman Materi -->
  <div id="materialPage" class="hidden min-h-screen flex flex-col items-center justify-center p-4"><!-- Header -->
   <div class="text-center mb-4">
    <h2 class="text-2xl md:text-3xl font-bold mb-2 game-title">ğŸ“– Materi Pembelajaran ğŸ“š</h2>
    <div class="text-3xl md:text-4xl mb-2 floating">
     ğŸ“š
    </div>
    <p class="text-base md:text-lg text-white neon-text">Kesebangunan dalam Budaya Melayu</p>
   </div><!-- Slide Container -->
   <div class="glass-card rounded-2xl p-4 max-w-4xl mx-auto w-full mb-4">
    <div class="relative bg-white/95 rounded-xl p-4 md:p-6 shadow-2xl min-h-[400px] md:min-h-[450px]"><!-- Slide 1 -->
     <div id="slide1" class="slide-content">
      <div class="text-center mb-4">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-3">Mengenal Bentuk Segitiga</h3>
      </div>
      <div class="flex flex-col lg:flex-row items-center gap-4">
       <div class="w-full lg:w-1/2">
        <div class="bg-white p-3 rounded-lg shadow-lg cursor-pointer hover:scale-105 transition-transform duration-300" onclick="showSlide1Popup()"><img src="https://i.imgur.com/1As20RS.png" alt="Rumah Adat Melayu" class="w-full h-auto max-h-48 object-contain rounded-lg mb-2" onerror="this.src='https://imgur.com/1As20RS.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ </div><p class=\'text-lg font-bold text-gray-800\'>Rumah Adat Melayu</p><p class=\'text-sm text-gray-600\'>Gambar tidak dapat dimuat</p>'; }">
        </div>
        <p class="text-xs text-gray-600 text-center mt-1">ğŸ‘† Klik untuk melihat jawaban!</p>
       </div>
       <div class="w-full lg:w-1/2 text-center lg:text-left">
        <div class="bg-gradient-to-r from-blue-100 to-purple-100 p-4 rounded-lg">
         <h4 class="text-base md:text-lg font-bold text-gray-800 mb-3">ğŸ¤” Pertanyaan:</h4>
         <p class="text-sm md:text-base text-gray-700 font-semibold leading-relaxed">Bagian mana dari rumah adat ini yang berbentuk segitiga?</p>
         <div class="mt-3 text-3xl">
          ğŸ”
         </div>
        </div>
       </div>
      </div>
     </div><!-- Slide 2 -->
     <div id="slide2" class="slide-content hidden">
      <div class="text-center mb-4">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-3">Membandingkan Bentuk</h3>
      </div>
      <div class="flex flex-col lg:flex-row items-center gap-4">
       <div class="w-full lg:w-1/2">
        <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/q0zRUtd.png" alt="Perbandingan Segitiga" class="w-full h-auto max-h-48 object-contain rounded-lg mb-2" onerror="this.src='https://imgur.com/q0zRUtd.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“</div><p class=\'text-lg font-bold text-gray-800\'>Perbandingan Segitiga</p>'; }">
        </div>
       </div>
       <div class="w-full lg:w-1/2 text-center lg:text-left">
        <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-lg">
         <h4 class="text-base md:text-lg font-bold text-gray-800 mb-3">ğŸ¤” Pertanyaan:</h4>
         <p class="text-sm md:text-base text-gray-700 font-semibold leading-relaxed mb-3">Apakah segitiga putih dan segitiga merah memiliki bentuk yang sama?</p>
         <div id="slide2-buttons" class="space-y-3"><button id="slide2BtnSama" class="w-full bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 hover:from-green-600 hover:via-emerald-600 hover:to-teal-600 text-white px-4 py-3 rounded-lg font-bold text-sm transition-all duration-300 transform hover:scale-105 shadow-lg border-2 border-green-400 hover:shadow-xl" onclick="answerSlide2('sama')" style="z-index: 99999 !important;">
           <div class="flex items-center justify-center space-x-2"><span class="text-lg">âœ…</span> <span>Sama</span> <span class="text-lg animate-bounce">ğŸ¯</span>
           </div></button> <button id="slide2BtnTidakSama" class="w-full bg-gradient-to-r from-red-500 via-pink-500 to-rose-500 hover:from-red-600 hover:via-pink-600 hover:to-rose-600 text-white px-4 py-3 rounded-lg font-bold text-sm transition-all duration-300 transform hover:scale-105 shadow-lg border-2 border-red-400 hover:shadow-xl" onclick="answerSlide2('tidak sama')" style="z-index: 99999 !important;">
           <div class="flex items-center justify-center space-x-2"><span class="text-lg">âŒ</span> <span>Tidak Sama</span> <span class="text-lg animate-bounce">ğŸ¤”</span>
           </div></button>
         </div>
         <div id="slide2-feedback" class="hidden mt-4 p-3 rounded-lg"><!-- Feedback will appear here -->
         </div>
        </div>
       </div>
      </div>
     </div><!-- Slide 3 -->
     <div id="slide3" class="slide-content hidden">
      <div class="text-center mb-4">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-3">Menganalisis Sudut dan Sisi</h3>
      </div>
      <div class="flex flex-col lg:flex-row items-center gap-4">
       <div class="w-full lg:w-1/2">
        <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/WjaUhR6.png" alt="Analisis Sudut dan Sisi" class="w-full h-auto max-h-48 object-contain rounded-lg mb-2" onerror="this.src='https://imgur.com/WjaUhR6.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“</div><p class=\'text-lg font-bold text-gray-800\'>Analisis Sudut dan Sisi</p>'; }">
        </div>
       </div>
       <div class="w-full lg:w-1/2 text-center lg:text-left">
        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-lg">
         <h4 class="text-base md:text-lg font-bold text-gray-800 mb-3">ğŸ¤” Pertanyaan:</h4>
         <div class="space-y-2 mb-3">
          <p class="text-xs md:text-sm text-gray-700 font-semibold leading-relaxed">â€¢ Apakah sudut-sudut yang bersesuaian pada kedua segitiga sama besar?</p>
          <p class="text-xs md:text-sm text-gray-700 font-semibold leading-relaxed">â€¢ Apakah sisi-sisi yang bersesuaian memiliki perbandingan yang sama?</p>
         </div>
         <div id="slide3-buttons" class="space-y-3"><button id="slide3BtnSama" class="w-full bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 hover:from-blue-600 hover:via-indigo-600 hover:to-purple-600 text-white px-4 py-3 rounded-lg font-bold text-sm transition-all duration-300 transform hover:scale-105 shadow-lg border-2 border-blue-400 hover:shadow-xl" onclick="answerSlide3('sama')" style="z-index: 99999 !important;">
           <div class="flex items-center justify-center space-x-2"><span class="text-lg">âœ…</span> <span>Sama</span> <span class="text-lg animate-bounce">ğŸ“</span>
           </div></button> <button id="slide3BtnTidakSama" class="w-full bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 hover:from-orange-600 hover:via-red-600 hover:to-pink-600 text-white px-4 py-3 rounded-lg font-bold text-sm transition-all duration-300 transform hover:scale-105 shadow-lg border-2 border-orange-400 hover:shadow-xl" onclick="answerSlide3('tidak sama')" style="z-index: 99999 !important;">
           <div class="flex items-center justify-center space-x-2"><span class="text-lg">âŒ</span> <span>Tidak Sama</span> <span class="text-lg animate-bounce">ğŸ¤·</span>
           </div></button>
         </div>
         <div id="slide3-feedback" class="hidden mt-4 p-3 rounded-lg"><!-- Feedback will appear here -->
         </div>
        </div>
       </div>
      </div>
      <div id="slide3-explanation" class="hidden mt-4">
       <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/x1f1LQy.png" alt="Penjelasan Kesebangunan" class="w-full h-auto max-h-48 object-contain rounded-lg" onerror="this.src='https://imgur.com/x1f1LQy.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“š</div><p class=\'text-lg font-bold text-gray-800\'>Penjelasan Kesebangunan</p>'; }">
       </div>
      </div>
     </div><!-- Slide 4 -->
     <div id="slide4" class="slide-content hidden">
      <div class="text-center mb-4">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-3">Menemukan Hubungan</h3>
      </div>
      <div class="flex flex-col lg:flex-row items-center gap-4">
       <div class="w-full lg:w-1/2">
        <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/l5Ts113.png" alt="Hubungan Segitiga" class="w-full h-auto max-h-48 object-contain rounded-lg mb-2" onerror="this.src='https://imgur.com/l5Ts113.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“</div><p class=\'text-lg font-bold text-gray-800\'>Hubungan Segitiga</p>'; }">
        </div>
       </div>
       <div class="w-full lg:w-1/2 text-center lg:text-left">
        <div class="bg-gradient-to-r from-pink-100 to-red-100 p-4 rounded-lg">
         <h4 class="text-base md:text-lg font-bold text-gray-800 mb-3">ğŸ¤” Pertanyaan:</h4>
         <p class="text-sm md:text-base text-gray-700 font-semibold leading-relaxed mb-3">Menurutmu, apa hubungan antara segitiga putih dan segitiga merah?</p><textarea id="slide4Answer" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm" rows="3" placeholder="Tuliskan pendapat Anda di sini..." oninput="checkSlide4Answer()" style="z-index: 99999 !important; resize: vertical;"></textarea>
         <div id="slide4Feedback" class="mt-3 p-3 rounded-lg hidden">
          <p class="text-green-600 font-semibold text-sm">âœ… Terima kasih atas jawaban Anda! Sekarang Anda bisa melanjutkan ke slide berikutnya.</p>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Slide 5 -->
     <div id="slide5" class="slide-content hidden">
      <div class="text-center mb-4">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-3">Konsep Kesebangunan</h3>
      </div>
      <div class="space-y-4">
       <div class="text-center mb-4">
        <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/l5Ts113.png" alt="Hubungan Segitiga" class="w-full h-auto max-h-32 object-contain rounded-lg mb-2 mx-auto" onerror="this.src='https://imgur.com/l5Ts113.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“</div><p class=\'text-lg font-bold text-gray-800\'>Hubungan Segitiga</p>'; }">
        </div>
       </div>
       <div class="bg-gradient-to-r from-indigo-100 to-purple-100 p-4 rounded-lg">
        <p class="text-sm text-gray-700 mb-3 leading-relaxed">Segitiga putih dan segitiga merah merupakan dua segitiga yang sebangun.</p>
        <p class="text-sm text-gray-700 mb-3 leading-relaxed">Kesebangunan adalah hubungan dua bangun yang memiliki bentuk sama tetapi ukuran belum tentu sama. Dua bangun dikatakan sebangun jika:</p>
        <div class="bg-white p-3 rounded-lg">
         <ul class="text-left space-y-1 text-gray-700 text-xs">
          <li class="flex items-start"><span class="text-blue-500 mr-2">â€¢</span> Bentuknya sama (sudut-sudut yang bersesuaian sama besar).</li>
          <li class="flex items-start"><span class="text-blue-500 mr-2">â€¢</span> Perbandingan panjang sisi-sisi yang bersesuaian sama.</li>
         </ul>
        </div>
       </div>
       <div class="text-center mb-4">
        <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/0BBJVdf.png" alt="Ilustrasi Kesebangunan" class="w-full h-auto max-h-32 object-contain rounded-lg mb-2 mx-auto" onerror="this.src='https://imgur.com/0BBJVdf.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“</div><p class=\'text-lg font-bold text-gray-800\'>Ilustrasi Kesebangunan</p>'; }">
         <p class="text-sm font-semibold text-gray-800">Ilustrasi Kesebangunan</p>
        </div>
       </div>
       <div class="bg-gradient-to-r from-orange-100 to-red-100 p-4 rounded-lg mb-4">
        <h4 class="text-base md:text-lg font-bold text-gray-800 mb-3 text-center">Rumus perbandingan sisi:</h4>
        <div class="text-center">
         <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/65FKX3K.png" alt="Rumus Perbandingan Sisi" class="w-full h-auto max-h-20 object-contain rounded-lg mx-auto" onerror="this.src='https://imgur.com/65FKX3K.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-4xl mb-2\'>ğŸ“</div><p class=\'text-lg font-bold text-gray-800\'>aâ‚/aâ‚‚ = bâ‚/bâ‚‚ = câ‚/câ‚‚</p>'; }">
         </div>
        </div>
       </div>
       <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-lg text-center">
        <h4 class="text-base font-bold text-gray-800 mb-2">Simbol kesebangunan:</h4>
        <div class="text-center mb-2">
         <p class="text-lg font-bold text-gray-800">âˆ†ABC ~ âˆ†DEF</p>
        </div>
        <p class="text-sm text-gray-700 mt-2">yang artinya segitiga ABC sebangun dengan segitiga DEF.</p>
       </div>
      </div>
     </div><!-- Slide 6 -->
     <div id="slide6" class="slide-content hidden">
      <div class="text-center mb-4">
       <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-3">Contoh Soal</h3>
      </div>
      <div class="space-y-4">
       <div class="bg-gradient-to-r from-blue-100 to-indigo-100 p-4 rounded-lg">
        <h4 class="text-base md:text-lg font-bold text-gray-800 mb-3">ğŸ“ Contoh Soal:</h4>
        <div class="text-center mb-3">
         <div class="bg-white p-3 rounded-lg shadow-lg"><img src="https://i.imgur.com/3hiKbI9.png" alt="Contoh Soal Kesebangunan" class="w-full h-auto max-h-64 object-contain rounded-lg mb-2 mx-auto" onerror="this.src='https://imgur.com/3hiKbI9.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-6xl mb-4\'>ğŸ“</div><p class=\'text-lg font-bold text-gray-800\'>Contoh Soal Kesebangunan</p>'; }">
         </div>
        </div>
        <p class="text-sm text-gray-700 leading-relaxed text-center">Jika panjang alas segitiga putih adalah <strong>8 m</strong>, dan panjang alas segitiga merah adalah <strong>4 m</strong>, serta tinggi segitiga merah adalah <strong>3 m</strong>, berapakah tinggi segitiga putih?</p>
       </div>
       <div class="bg-gradient-to-r from-green-100 to-teal-100 p-4 rounded-lg">
        <h4 class="text-base md:text-lg font-bold text-gray-800 mb-3">âœ… Jawaban:</h4>
        <div class="space-y-3">
         <div class="bg-white p-3 rounded-lg">
          <h5 class="text-sm font-bold text-gray-800 mb-2">Langkah Pertama (Memahami masalah)</h5>
          <p class="text-xs text-gray-700 mb-1"><strong>Diketahui:</strong></p>
          <ul class="text-xs text-gray-700 ml-3 space-y-1">
           <li>â€¢ Segitiga putih sebangun dengan segitiga merah</li>
           <li>â€¢ Panjang alas segitiga putih = 8 m</li>
           <li>â€¢ Panjang alas segitiga merah = 4 m</li>
           <li>â€¢ Tinggi segitiga merah = 3 m</li>
          </ul>
          <p class="text-xs text-gray-700 mt-1"><strong>Ditanyakan:</strong></p>
          <p class="text-xs text-gray-700 ml-3">Berapa tinggi segitiga putih?</p>
         </div>
         <div class="bg-white p-3 rounded-lg">
          <h5 class="text-sm font-bold text-gray-800 mb-2">Langkah Kedua (Merencanakan masalah)</h5>
          <p class="text-xs text-gray-700 mb-2">Karena kedua segitiga sebangun, perbandingan sisi-sisi yang bersesuaian adalah sama. Tuliskan perbandingan sisi yang bersesuaian.</p>
          <div class="text-center my-3">
           <div class="bg-white p-2 rounded-lg shadow-lg mb-3"><img src="https://i.imgur.com/ASCSdxT.png" alt="Perbandingan Sisi" class="w-full h-auto max-h-16 object-contain rounded-lg mx-auto" onerror="this.src='https://imgur.com/ASCSdxT.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<p class=\'text-lg font-bold text-gray-800\'>alasâ‚/alasâ‚‚ = tinggiâ‚/tinggiâ‚‚</p>'; }">
           </div>
           <div class="bg-white p-2 rounded-lg shadow-lg"><img src="https://i.imgur.com/jIB1g1q.png" alt="Substitusi Nilai" class="w-full h-auto max-h-16 object-contain rounded-lg mx-auto" onerror="this.src='https://imgur.com/jIB1g1q.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<p class=\'text-lg font-bold text-gray-800\'>8/4 = tinggiâ‚/3</p>'; }">
           </div>
          </div>
          <p class="text-xs text-gray-700">Kemudian mencari nilai tinggi â–³putih (menggunakan perkalian silang).</p>
         </div>
         <div class="bg-white p-3 rounded-lg">
          <h5 class="text-sm font-bold text-gray-800 mb-2">Langkah Ketiga (Menjalankan rencana)</h5>
          <p class="text-xs text-gray-700 mb-2">Menentukan nilai tinggi â–³putih</p>
          <div class="text-center">
           <div class="bg-white p-2 rounded-lg shadow-lg"><img src="https://i.imgur.com/oF3A155.png" alt="Penyelesaian" class="w-full h-auto max-h-20 object-contain rounded-lg mx-auto" onerror="this.src='https://imgur.com/oF3A155.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<p class=\'text-lg font-bold text-gray-800\'>tinggiâ‚ = (8 Ã— 3) Ã· 4 = 6 m</p>'; }">
           </div>
          </div>
         </div>
         <div class="bg-white p-3 rounded-lg">
          <h5 class="text-sm font-bold text-gray-800 mb-2">Langkah Keempat (Memeriksa kebenaran)</h5>
          <p class="text-xs text-gray-700 mb-2">Dengan menggunakan perbandingan sisi pada bangun yang sebangun, maka diperoleh tinggi segitiga putih yaitu 6 m.</p>
          <p class="text-xs text-gray-700 mb-2">Perbandingan sisi-sisi yang bersesuaian sama:</p>
          <div class="text-center mb-2">
           <div class="bg-white p-2 rounded-lg shadow-lg"><img src="https://i.imgur.com/oQ20VAh.png" alt="Pemeriksaan Kebenaran" class="w-full h-auto max-h-12 object-contain rounded-lg mx-auto" onerror="this.src='https://imgur.com/oQ20VAh.png'; if(this.complete &amp;&amp; this.naturalWidth === 0) { this.style.display='none'; this.parentElement.innerHTML='<p class=\'text-lg font-bold text-gray-800\'>8/4 = 6/3 = 2</p>'; }">
           </div>
          </div>
          <p class="text-xs text-gray-700">Karena semua perbandingan sisi yang bersesuaian sama, maka benar segitiga putih dan segitiga merah sebangun dan tinggi segitiga putih adalah 6 m.</p>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Slide Navigation -->
     <div class="flex justify-center mt-4 mb-3">
      <div class="flex space-x-2"><button class="slide-indicator active" onclick="playSound('click'); showMaterialSlide(1)" style="z-index: 99999 !important;"></button> <button class="slide-indicator" onclick="playSound('click'); showMaterialSlide(2)" style="z-index: 99999 !important;"></button> <button class="slide-indicator" onclick="playSound('click'); showMaterialSlide(3)" style="z-index: 99999 !important;"></button> <button class="slide-indicator" onclick="playSound('click'); showMaterialSlide(4)" style="z-index: 99999 !important;"></button> <button class="slide-indicator" onclick="playSound('click'); showMaterialSlide(5)" style="z-index: 99999 !important;"></button> <button class="slide-indicator" onclick="playSound('click'); showMaterialSlide(6)" style="z-index: 99999 !important;"></button>
      </div>
     </div>
    </div>
   </div><!-- Navigation Buttons - Outside Frame -->
   <div class="flex justify-between items-center w-full max-w-4xl mx-auto mt-4 px-4"><button class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-2 rounded-full font-bold text-sm" onclick="showPage('homePage')" style="z-index: 99999 !important;"> ğŸ  Beranda </button>
    <div class="flex space-x-3"><button id="materialPrevBtn" class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white px-4 py-2 rounded-full font-bold text-sm disabled:opacity-50" onclick="previousMaterialSlide()" style="z-index: 99999 !important;" disabled> â¬…ï¸ Sebelumnya </button> <button id="materialNextBtn" class="neon-button px-4 py-2 rounded-full font-bold text-sm" onclick="nextMaterialSlide()" style="z-index: 99999 !important;"> Selanjutnya â¡ï¸ </button>
    </div>
   </div>
  </div><!-- Halaman Input Nama -->
  <div id="nameInputPage" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="glass-card rounded-3xl p-8 max-w-md mx-auto w-full">
    <div class="text-center mb-8">
     <h2 class="text-3xl md:text-4xl font-bold mb-4 game-title">ğŸ“ Masukkan Nama</h2>
     <div class="text-4xl md:text-6xl mb-4 floating">
      ğŸ‘¤
     </div>
     <p class="text-lg md:text-xl text-white">Siapa nama kamu?</p>
    </div>
    <div class="bg-white/95 rounded-3xl p-6 shadow-2xl">
     <div class="mb-6"><label for="playerName" class="block text-lg font-bold text-gray-800 mb-3 text-center"> ğŸŒŸ Nama Lengkap Kamu: </label> <input type="text" id="playerName" class="w-full px-6 py-4 text-lg border-3 border-gray-300 rounded-2xl focus:border-blue-500 focus:outline-none text-center font-semibold bg-white shadow-lg" placeholder="Masukkan nama kamu" maxlength="50" onkeypress="if(event.key==='Enter') startQuizWithName()" oninput="checkNameInput()" style="z-index: 99999 !important;">
     </div>
     <div class="space-y-4"><button id="startQuizBtn" class="w-full neon-button text-black px-8 py-4 rounded-full font-bold text-lg disabled:opacity-50" onclick="startQuizWithName()" disabled style="z-index: 99999 !important;"> ğŸš€ Mulai Latihan Soal </button> <button class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-4 rounded-full font-bold text-lg" onclick="showPage('homePage')" style="z-index: 99999 !important;"> â¬…ï¸ Kembali ke Beranda </button>
     </div>
    </div>
   </div>
  </div><!-- Halaman Quiz -->
  <div id="quizPage" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="glass-card rounded-3xl p-6 max-w-6xl mx-auto w-full holographic"><!-- Quiz Header -->
    <div class="text-center mb-6">
     <div class="relative mb-6">
      <div class="absolute -inset-4 bg-gradient-to-r from-pink-400 via-purple-500 to-indigo-500 rounded-3xl blur-xl opacity-30 animate-pulse"></div>
      <div class="relative">
       <h2 class="text-3xl md:text-4xl font-bold mb-4 game-title">ğŸš€ Latihan Soal ğŸ®</h2>
       <div class="text-4xl md:text-6xl mb-4 floating">
        ğŸ“
       </div>
       <p class="text-lg md:text-xl text-white neon-text">Uji Pemahaman Kesebangunan</p>
      </div>
     </div><!-- Player Name Display -->
     <div class="text-center mb-4">
      <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 p-1 rounded-2xl shadow-2xl inline-block">
       <div class="bg-white/95 px-6 py-3 rounded-xl">
        <div class="text-lg md:text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-600 to-red-600">
         ğŸ‘‹ Hai <span id="playerNameDisplay" class="text-orange-600"></span>!
        </div>
        <div class="text-sm text-gray-600 font-semibold">
         Selamat mengerjakan quiz
        </div>
       </div>
      </div>
     </div><!-- Quiz Stats -->
     <div class="flex justify-center space-x-8 mt-6 mb-4">
      <div class="text-center">
       <div class="text-xl md:text-2xl font-bold text-white mb-2">
        âœ… <span id="quizCorrectCount" class="text-green-400">0</span>
       </div>
       <div class="text-sm text-white font-semibold">
        Skor
       </div>
      </div>
      <div class="text-center">
       <div class="text-xl md:text-2xl font-bold text-white mb-2">
        â° <span id="quizTimer" class="text-blue-400">25:00</span>
       </div>
       <div class="text-sm text-white font-semibold">
        Waktu
       </div>
      </div>
     </div>
    </div><!-- Quiz Content -->
    <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl p-4 md:p-8 shadow-2xl min-h-[600px] border-2 border-white/50"><!-- Question Header -->
     <div class="text-center mb-6">
      <div class="bg-gradient-to-r from-orange-400 via-pink-500 to-purple-600 p-1 rounded-2xl mb-4 inline-block">
       <div class="bg-white px-6 py-3 rounded-xl">
        <h3 id="quizQuestionTitle" class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-purple-600 mb-2">Pertanyaan 1</h3>
        <p id="quizQuestionDescription" class="text-lg md:text-xl text-gray-700 font-semibold mb-0">Perhatikan gambar kain corak insang diatas!</p>
       </div>
      </div>
     </div><!-- Question Image -->
     <div class="text-center mb-6">
      <div class="bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 p-1 rounded-2xl shadow-2xl transform hover:scale-105 transition-all duration-300 inline-block">
       <div id="quizImageContainer" class="bg-white p-6 rounded-xl">
        <div class="text-6xl mb-4">
         ğŸ“
        </div>
        <p class="text-lg font-semibold text-gray-800">Gambar Soal</p>
       </div>
      </div>
     </div><!-- Question Context -->
     <div class="bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400 p-1 rounded-2xl mb-6 shadow-lg">
      <div class="bg-gradient-to-r from-yellow-50 via-orange-50 to-red-50 p-6 rounded-xl">
       <div class="flex items-center justify-center mb-3">
        <div class="text-3xl mr-3">
         ğŸ“‹
        </div>
        <h4 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-600 to-red-600">Informasi Soal</h4>
       </div>
       <p id="quizQuestionContext" class="text-gray-700 leading-relaxed text-center font-medium"></p>
      </div>
     </div>
     <div class="bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500 p-1 rounded-2xl mb-6 shadow-lg">
      <div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 p-6 rounded-xl">
       <div class="flex items-center justify-center mb-3">
        <div class="text-3xl mr-3">
         â“
        </div>
        <h4 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">Pertanyaan</h4>
       </div>
       <h4 id="quizSubQuestion" class="text-xl md:text-2xl font-bold text-gray-800 text-center mb-4"><!-- Sub question will be inserted here --></h4>
       <div id="quizQuestionImageContainer" class="text-center hidden">
       </div>
      </div>
     </div><!-- Question Display -->
     <div id="questionContainer"><!-- Answer Options -->
      <div class="bg-gradient-to-r from-green-400 via-teal-500 to-cyan-500 p-1 rounded-2xl mb-8 shadow-lg">
       <div class="bg-gradient-to-r from-green-50 via-teal-50 to-cyan-50 p-6 rounded-xl">
        <div class="flex items-center justify-center mb-4">
         <div class="text-3xl mr-3">
          ğŸ¯
         </div>
         <h4 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-cyan-600">Pilihan Jawaban</h4>
        </div><!-- Auto advance countdown -->
        <div id="autoAdvanceCountdown" class="hidden text-center mb-4">
         <div class="bg-gradient-to-r from-orange-100 to-red-100 p-4 rounded-xl border-2 border-orange-300">
          <div class="text-lg font-bold text-orange-800 mb-2">
           â° Otomatis lanjut dalam <span id="countdownTimer" class="text-red-600">5</span> detik
          </div>
          <div class="text-sm text-orange-700">
           Klik "Selanjutnya" untuk lanjut sekarang
          </div>
         </div>
        </div>
        <div id="quizOptions" class="space-y-4"><!-- Options will be generated here -->
        </div>
       </div>
      </div>
     </div><!-- Quiz Complete Screen -->
     <div id="quizCompleteScreen" class="hidden text-center">
      <div class="text-8xl mb-6">
       ğŸ‰
      </div>
      <h3 class="text-3xl font-bold text-gray-800 mb-4">Selamat! Quiz Selesai!</h3>
      <div class="bg-gradient-to-r from-green-100 to-blue-100 p-8 rounded-3xl mb-6">
       <div class="text-6xl mb-4" id="finalEmoji">
        ğŸ†
       </div>
       <h4 class="text-2xl font-bold text-gray-800 mb-4">Hasil Quiz Kamu:</h4>
       <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded-xl">
         <div class="text-2xl font-bold text-blue-600" id="finalScore">
          0
         </div>
         <div class="text-sm text-gray-600">
          Skor Total
         </div>
        </div>
        <div class="bg-white p-4 rounded-xl">
         <div class="text-2xl font-bold text-green-600" id="correctAnswers">
          0
         </div>
         <div class="text-sm text-gray-600">
          Benar
         </div>
        </div>
        <div class="bg-white p-4 rounded-xl">
         <div class="text-2xl font-bold text-red-600" id="wrongAnswers">
          0
         </div>
         <div class="text-sm text-gray-600">
          Salah
         </div>
        </div>
        <div class="bg-white p-4 rounded-xl">
         <div class="text-2xl font-bold text-purple-600" id="finalPercentage">
          0%
         </div>
         <div class="text-sm text-gray-600">
          Persentase
         </div>
        </div>
       </div>
       <p class="text-lg text-gray-800" id="finalMessage"></p>
      </div>
     </div>
    </div><!-- Navigation Controls -->
    <div class="flex justify-between items-center pt-6 border-t-4 border-purple-300"><button id="quizPrevBtn" class="bg-gradient-to-r from-gray-500 via-gray-600 to-gray-700 hover:from-gray-600 hover:via-gray-700 hover:to-gray-800 text-white px-6 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg border-2 border-gray-400" onclick="playSound('click'); previousQuizQuestion()"> â¬…ï¸ Sebelumnya </button>
     <div class="text-center bg-gradient-to-r from-indigo-100 to-purple-100 px-6 py-3 rounded-full border-2 border-indigo-300">
      <div class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
       Soal <span id="quizProgress2" class="text-purple-700">1</span> dari <span class="text-indigo-700">12</span>
      </div>
     </div><button id="quizNextBtn" class="neon-button text-black px-6 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg" onclick="playSound('click'); nextQuizQuestion()" disabled> Selanjutnya â¡ï¸ </button>
    </div>
   </div><!-- Back to Home Button -->
   <div class="text-center mt-8 pt-6 border-t-4 border-pink-300"><button class="bg-gradient-to-r from-red-500 via-pink-500 to-purple-500 hover:from-red-600 hover:via-pink-600 hover:to-purple-600 text-white px-8 py-4 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105 shadow-2xl border-2 border-red-400" onclick="playSound('click'); confirmExitQuiz()"> ğŸ  Keluar Quiz </button>
   </div>
  </div> <!-- Quiz Exit Confirmation Modal -->
  <div id="quizExitModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="glass-card rounded-3xl p-8 max-w-md mx-4 shadow-2xl bounce-in-3d glow-effect">
    <div class="text-center">
     <div class="text-8xl mb-4">
      âš ï¸
     </div>
     <h3 class="text-3xl font-bold text-gray-800 mb-4">Keluar Quiz?</h3>
     <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-6 rounded-xl mb-6">
      <p class="text-xl text-gray-700 font-semibold mb-2">Apakah kamu yakin ingin keluar?</p>
      <p class="text-lg text-gray-600">Progres quiz akan hilang dan tidak tersimpan.</p>
     </div>
     <div class="space-y-4"><button class="w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-8 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); exitQuiz()"> âœ… Ya, Keluar </button> <button class="w-full neon-button text-black px-8 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); closeExitQuiz()"> âŒ Batal </button>
     </div>
    </div>
   </div>
  </div><!-- Popup Modal for Slide 1 -->
  <div id="slide1PopupModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="glass-card rounded-3xl p-8 max-w-md mx-4 shadow-2xl bounce-in-3d glow-effect">
    <div class="text-center">
     <div class="text-6xl mb-4">
      ğŸ‰
     </div>
     <h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Jawaban Benar!</h3>
     <div class="bg-gradient-to-r from-green-100 to-blue-100 p-6 rounded-xl mb-6">
      <p class="text-lg md:text-xl text-gray-700 font-semibold leading-relaxed">Ya benar! Yang berbentuk segitiga adalah bagian atapnya! ğŸ </p>
     </div>
     <div class="text-4xl mb-4">
      âœ…
     </div><button class="neon-button text-black px-8 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('correct'); hideSlide1Popup()"> ğŸ‘ Mengerti! </button>
    </div>
   </div>
  </div><!-- Quiz Answer Popup - Correct -->
  <div id="quizCorrectPopup" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="glass-card rounded-3xl p-8 max-w-md mx-4 shadow-2xl bounce-in-3d glow-effect">
    <div class="text-center">
     <div class="text-8xl mb-4">
      ğŸ‰
     </div>
     <h3 class="text-3xl font-bold text-green-600 mb-4">Benar!</h3>
     <div class="bg-gradient-to-r from-green-100 to-emerald-100 p-6 rounded-xl">
      <div class="text-6xl mb-3">
       âœ…
      </div>
      <p class="text-xl text-green-800 font-bold">Jawaban kamu tepat!</p>
     </div>
    </div>
   </div>
  </div><!-- Quiz Answer Popup - Incorrect -->
  <div id="quizIncorrectPopup" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="glass-card rounded-3xl p-8 max-w-md mx-4 shadow-2xl bounce-in-3d glow-effect">
    <div class="text-center">
     <div class="text-8xl mb-4">
      ğŸ˜”
     </div>
     <h3 class="text-3xl font-bold text-red-600 mb-4">Salah!</h3>
     <div class="bg-gradient-to-r from-red-100 to-pink-100 p-6 rounded-xl">
      <div class="text-6xl mb-3">
       âŒ
      </div>
      <p class="text-xl text-red-800 font-bold">Jawaban kamu belum tepat!</p>
     </div>
    </div>
   </div>
  </div><!-- Halaman Memory Game -->
  <div id="memoryGamePage" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="glass-card rounded-3xl p-6 max-w-6xl mx-auto w-full"><!-- Memory Game Header -->
    <div class="text-center mb-6">
     <h2 class="text-3xl md:text-4xl font-bold mb-4 game-title">ğŸ® Cocokin Yuk! ğŸ§©</h2>
     <div class="text-4xl md:text-6xl mb-4 floating">
      ğŸ¥
     </div>
     <p class="text-lg md:text-xl text-white neon-text">Game Memori Rebana Melayu</p><!-- Game Stats -->
     <div class="flex justify-center space-x-8 mt-6 mb-4">
      <div class="bg-gradient-to-r from-blue-100 to-purple-100 px-6 py-3 rounded-xl">
       <div class="text-2xl font-bold text-gray-800">
        â° <span id="memoryGameTimer" class="text-blue-600">0:00</span>
       </div>
       <div class="text-sm text-gray-600">
        Waktu
       </div>
      </div>
      <div class="bg-gradient-to-r from-green-100 to-teal-100 px-6 py-3 rounded-xl">
       <div class="text-2xl font-bold text-gray-800">
        ğŸ¯ <span id="memoryGameMatches" class="text-green-600">0</span>/6
       </div>
       <div class="text-sm text-gray-600">
        Pasangan
       </div>
      </div>
     </div><!-- Instructions -->
     <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-xl mb-6">
      <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ“‹ Cara Bermain:</h3>
      <p class="text-gray-700">Klik kartu untuk membaliknya dan temukan pasangan gambar rebana yang sebangun!</p>
     </div>
    </div><!-- Memory Game Board -->
    <div class="bg-white/95 rounded-2xl p-4 md:p-6 shadow-2xl">
     <div id="memoryGameBoard" class="memory-game-board"><!-- Cards will be generated here -->
     </div><!-- Game Complete Message -->
     <div id="gameCompleteMessage" class="hidden text-center mt-8 p-6 bg-gradient-to-r from-green-100 to-blue-100 rounded-3xl">
      <div class="text-8xl mb-4">
       ğŸ‰
      </div>
      <h3 class="text-3xl font-bold text-gray-800 mb-4">Selamat! Kamu Berhasil!</h3>
      <div class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
       <div class="bg-white p-4 rounded-xl">
        <div class="text-2xl font-bold text-purple-600" id="finalTime">
         00:00
        </div>
        <div class="text-sm text-gray-600">
         Waktu
        </div>
       </div>
       <div class="bg-white p-4 rounded-xl">
        <div class="text-2xl font-bold text-green-600" id="gameRating">
         â­â­â­
        </div>
        <div class="text-sm text-gray-600">
         Rating
        </div>
       </div>
      </div>
      <p class="text-lg text-gray-800 mb-4" id="congratsMessage">Hebat! Kamu berhasil mencocokkan semua rebana sebangun!</p>
     </div>
    </div><!-- Control Buttons -->
    <div class="flex justify-center space-x-4 mt-6"><button class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); showPage('homePage')" style="z-index: 99999 !important;"> ğŸ  Beranda </button> <button class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white px-6 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); resetMemoryGame()" style="z-index: 99999 !important;"> ğŸ”„ Reset </button>
    </div>
   </div>
  </div><!-- Halaman Host Login -->
  <div id="hostLoginPage" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="glass-card rounded-3xl p-8 max-w-md mx-auto w-full">
    <div class="text-center mb-8">
     <h2 class="text-3xl md:text-4xl font-bold mb-4 game-title">ğŸ‘¨â€ğŸ« Login Host</h2>
     <div class="text-4xl md:text-6xl mb-4 floating">
      ğŸ”
     </div>
     <p class="text-lg md:text-xl text-white">Akses Dashboard Host</p>
    </div>
    <div class="bg-white/95 rounded-3xl p-6 shadow-2xl">
     <div class="mb-6"><label for="hostPassword" class="block text-lg font-bold text-gray-800 mb-3 text-center"> ğŸ”‘ Password Host: </label> <input type="password" id="hostPassword" class="w-full px-6 py-4 text-lg border-3 border-gray-300 rounded-2xl focus:border-blue-500 focus:outline-none text-center font-semibold bg-white shadow-lg" placeholder="Masukkan password host" onkeypress="if(event.key==='Enter') loginHost()" style="z-index: 99999 !important;">
     </div>
     <div class="space-y-4"><button class="w-full neon-button text-black px-8 py-4 rounded-full font-bold text-lg" onclick="loginHost()" style="z-index: 99999 !important;"> ğŸš€ Masuk Dashboard </button> <button class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-4 rounded-full font-bold text-lg" onclick="showPage('homePage')" style="z-index: 99999 !important;"> â¬…ï¸ Kembali ke Beranda </button>
     </div>
    </div>
   </div>
  </div><!-- Halaman Hasil Quiz -->
  <div id="quizResultPage" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="glass-card rounded-3xl p-8 max-w-2xl mx-auto w-full holographic">
    <div class="text-center mb-8">
     <div class="relative mb-6">
      <div class="absolute -inset-4 bg-gradient-to-r from-green-400 via-blue-500 to-purple-500 rounded-3xl blur-xl opacity-30 animate-pulse"></div>
      <div class="relative">
       <h2 class="text-3xl md:text-4xl font-bold mb-4 game-title">ğŸ‰ Hasil Quiz ğŸ†</h2>
       <div id="resultEmoji" class="text-6xl md:text-8xl mb-4 floating">
        ğŸŠ
       </div>
       <p class="text-lg md:text-xl text-white neon-text">Selamat telah menyelesaikan quiz!</p>
      </div>
     </div>
    </div>
    <div class="bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl p-6 shadow-2xl border-2 border-white/50">
     <div id="quizResultContent" class="text-center"><!-- Results will be shown here -->
     </div>
     <div class="space-y-4 mt-8"><button class="w-full neon-button text-black px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg" onclick="playSound('click'); startQuiz()" style="z-index: 99999 !important;"> ğŸ”„ Coba Lagi </button> <button class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg" onclick="playSound('click'); showPage('homePage')" style="z-index: 99999 !important;"> ğŸ  Kembali ke Beranda </button>
     </div>
    </div>
   </div>
  </div><!-- Halaman Dashboard Host -->
  <div id="hostDashboardPage" class="hidden min-h-screen p-4">
   <div class="max-w-7xl mx-auto"><!-- Header -->
    <div class="glass-card rounded-3xl p-6 mb-6">
     <div class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold mb-4 game-title">ğŸ‘¨â€ğŸ« Dashboard Host</h1>
      <p class="text-lg md:text-xl text-white">Monitoring Real-time User Activity</p>
     </div>
     <div class="flex justify-between items-center">
      <div class="flex space-x-3"><button class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-6 py-3 rounded-full font-bold" style="z-index: 99999 !important;" onclick="showPage('homePage')"> ğŸ  Kembali ke Beranda </button> <button class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-6 py-3 rounded-full font-bold" style="z-index: 99999 !important;" onclick="logoutHost()"> ğŸšª Logout Host </button>
      </div>
      <div class="flex space-x-4"><button class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white px-6 py-3 rounded-full font-bold" onclick="refreshDashboardData()" style="z-index: 99999 !important;"> ğŸ”„ Refresh Data </button>
       <div class="bg-gradient-to-r from-green-100 to-blue-100 px-4 py-2 rounded-full"><span class="text-sm font-bold text-gray-800">ğŸ“Š Total Users: <span id="totalUsersCount" class="text-blue-600">0</span></span>
       </div>
      </div>
     </div>
    </div><!-- Dashboard Tabs -->
    <div class="glass-card rounded-2xl p-6"><!-- Tab Navigation -->
     <div class="flex flex-wrap justify-center space-x-2 mb-6 bg-white/10 p-2 rounded-xl"><button class="dashboard-tab active bg-gradient-to-r from-blue-500 to-indigo-500 text-white" onclick="showDashboardTab('users')" style="z-index: 99999 !important;"> ğŸ‘¥ Semua User </button> <button class="dashboard-tab bg-white/20 text-white hover:bg-white/30" onclick="showDashboardTab('material')" style="z-index: 99999 !important;"> ğŸ“š Skor Materi </button> <button class="dashboard-tab bg-white/20 text-white hover:bg-white/30" onclick="showDashboardTab('quiz')" style="z-index: 99999 !important;"> ğŸ“ Skor Quiz </button> <button class="dashboard-tab bg-white/20 text-white hover:bg-white/30" onclick="showDashboardTab('game')" style="z-index: 99999 !important;"> ğŸ® Game Rebana </button> <button class="dashboard-tab bg-white/20 text-white hover:bg-white/30" onclick="showDashboardTab('management')" style="z-index: 99999 !important;"> ğŸ“Š Manajemen Data </button>
     </div><!-- Tab Content --> <!-- Users Tab -->
     <div id="usersTab" class="dashboard-tab-content">
      <div class="bg-white/95 rounded-xl p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ğŸ‘¥ Semua User yang Mengakses Aplikasi</h3>
        <div class="text-sm text-gray-600"><span id="usersLastUpdate">Terakhir update: -</span>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300">
         <thead>
          <tr class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white">
           <th class="border border-gray-300 px-4 py-3 text-left">No</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Nama User</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Device</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Waktu Akses</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Status</th>
          </tr>
         </thead>
         <tbody id="usersTableBody">
          <tr>
           <td colspan="5" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
            <div class="text-4xl mb-2">
             â³
            </div><p>Memuat data user...</p></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- Material Tab -->
     <div id="materialTab" class="dashboard-tab-content hidden">
      <div class="bg-white/95 rounded-xl p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ğŸ“š Skor Pemahaman Materi</h3>
        <div class="text-sm text-gray-600"><span id="materialLastUpdate">Terakhir update: -</span>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300">
         <thead>
          <tr class="bg-gradient-to-r from-green-500 to-teal-500 text-white">
           <th class="border border-gray-300 px-4 py-3 text-left">No</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Nama User</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Slide 2</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Slide 3</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Slide 4</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Waktu</th>
          </tr>
         </thead>
         <tbody id="materialTableBody">
          <tr>
           <td colspan="6" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
            <div class="text-4xl mb-2">
             â³
            </div><p>Memuat data materi...</p></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- Quiz Tab -->
     <div id="quizTab" class="dashboard-tab-content hidden">
      <div class="bg-white/95 rounded-xl p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ğŸ“ Skor Latihan Soal</h3>
        <div class="text-sm text-gray-600"><span id="quizLastUpdate">Terakhir update: -</span>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300">
         <thead>
          <tr class="bg-gradient-to-r from-purple-500 to-pink-500 text-white">
           <th class="border border-gray-300 px-4 py-3 text-left">No</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Nama User</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Skor Total</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Benar</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Salah</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Persentase</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Waktu</th>
          </tr>
         </thead>
         <tbody id="quizTableBody">
          <tr>
           <td colspan="7" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
            <div class="text-4xl mb-2">
             â³
            </div><p>Memuat data quiz...</p></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- Game Tab -->
     <div id="gameTab" class="dashboard-tab-content hidden">
      <div class="bg-white/95 rounded-xl p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ğŸ® Game Rebana (Cocokin Yuk!)</h3>
        <div class="text-sm text-gray-600"><span id="gameLastUpdate">Terakhir update: -</span>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300">
         <thead>
          <tr class="bg-gradient-to-r from-orange-500 to-red-500 text-white">
           <th class="border border-gray-300 px-4 py-3 text-left">No</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Nama User</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Durasi Bermain</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Status</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Rating</th>
           <th class="border border-gray-300 px-4 py-3 text-left">Waktu</th>
          </tr>
         </thead>
         <tbody id="gameTableBody">
          <tr>
           <td colspan="6" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
            <div class="text-4xl mb-2">
             â³
            </div><p>Memuat data game...</p></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div><!-- Management Tab -->
     <div id="managementTab" class="dashboard-tab-content hidden">
      <div class="bg-white/95 rounded-xl p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ğŸ“Š Manajemen Data &amp; Rekap</h3>
        <div class="flex space-x-3"><button class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm" onclick="exportToCSV()" style="z-index: 99999 !important;"> ğŸ“¥ Download CSV </button>
         <div class="text-sm text-gray-600"><span id="managementLastUpdate">Terakhir update: -</span>
         </div>
        </div>
       </div><!-- Summary Cards -->
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-r from-blue-100 to-blue-200 p-4 rounded-lg">
         <div class="text-2xl font-bold text-blue-800" id="totalUsers">
          0
         </div>
         <div class="text-sm text-blue-600">
          Total Users
         </div>
        </div>
        <div class="bg-gradient-to-r from-green-100 to-green-200 p-4 rounded-lg">
         <div class="text-2xl font-bold text-green-800" id="completedMaterial">
          0
         </div>
         <div class="text-sm text-green-600">
          Selesai Materi
         </div>
        </div>
        <div class="bg-gradient-to-r from-purple-100 to-purple-200 p-4 rounded-lg">
         <div class="text-2xl font-bold text-purple-800" id="completedQuiz">
          0
         </div>
         <div class="text-sm text-purple-600">
          Selesai Quiz
         </div>
        </div>
        <div class="bg-gradient-to-r from-orange-100 to-orange-200 p-4 rounded-lg">
         <div class="text-2xl font-bold text-orange-800" id="completedGame">
          0
         </div>
         <div class="text-sm text-orange-600">
          Selesai Game
         </div>
        </div>
       </div><!-- Comprehensive Data Table -->
       <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300 text-sm">
         <thead>
          <tr class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
           <th class="border border-gray-300 px-3 py-2 text-left">No</th>
           <th class="border border-gray-300 px-3 py-2 text-left">Nama User</th>
           <th class="border border-gray-300 px-3 py-2 text-left">Materi (S2/S3/S4)</th>
           <th class="border border-gray-300 px-3 py-2 text-left">Quiz Score</th>
           <th class="border border-gray-300 px-3 py-2 text-left">Quiz %</th>
           <th class="border border-gray-300 px-3 py-2 text-left">Game Time</th>
           <th class="border border-gray-300 px-3 py-2 text-left">Terakhir Aktif</th>
          </tr>
         </thead>
         <tbody id="managementTableBody">
          <tr>
           <td colspan="7" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
            <div class="text-4xl mb-2">
             â³
            </div><p>Memuat data manajemen...</p></td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Quiz Results Modal -->
  <div id="quizResultsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="glass-card rounded-3xl p-8 max-w-lg mx-4 shadow-2xl bounce-in-3d glow-effect">
    <div class="text-center">
     <div id="quizResultEmoji" class="text-8xl mb-4">
      ğŸ‰
     </div>
     <h3 id="quizResultTitle" class="text-3xl font-bold text-gray-800 mb-4">Selamat!</h3>
     <div class="bg-gradient-to-r from-blue-100 to-purple-100 p-6 rounded-xl mb-6">
      <div class="grid grid-cols-2 gap-4 mb-4">
       <div class="text-center">
        <div class="text-3xl font-bold text-gray-800 mb-2"><span id="quizFinalScore" class="text-blue-600">0</span>/<span id="quizTotalQuestions" class="text-gray-600">12</span>
        </div>
        <div class="text-sm text-gray-600">
         Jawaban Benar
        </div>
       </div>
       <div class="text-center">
        <div class="text-3xl font-bold text-gray-800 mb-2"><span id="quizFinalPercentage" class="text-green-600">0%</span>
        </div>
        <div class="text-sm text-gray-600">
         Persentase
        </div>
       </div>
      </div>
      <div class="text-center mb-4">
       <div class="text-2xl font-bold text-gray-800">
        â° <span id="quizFinalTime" class="text-purple-600">0:00</span>
       </div>
       <div class="text-sm text-gray-600">
        Waktu Pengerjaan
       </div>
      </div>
      <p id="quizScoreMessage" class="text-lg text-gray-700 font-semibold text-center">Hebat sekali!</p>
     </div>
     <div class="space-y-4"><button class="w-full neon-button text-black px-8 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); closeQuizResults(); restartQuiz()" style="z-index: 99999 !important;"> ğŸ”„ Coba Lagi </button> <button class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); closeQuizResults(); showPage('homePage')" style="z-index: 99999 !important;"> ğŸ  Kembali ke Beranda </button>
     </div>
    </div>
   </div>
  </div><!-- Memory Game Results Modal -->
  <div id="memoryGameResultsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="glass-card rounded-3xl p-8 max-w-lg mx-4 shadow-2xl bounce-in-3d glow-effect">
    <div class="text-center">
     <div id="memoryResultEmoji" class="text-8xl mb-4">
      ğŸ‰
     </div>
     <h3 class="text-3xl font-bold text-gray-800 mb-4">Selamat!</h3>
     <div class="bg-gradient-to-r from-blue-100 to-purple-100 p-6 rounded-xl mb-6">
      <p class="text-xl text-gray-700 font-semibold mb-2">Kamu berhasil mencocokkan semua pasangan rebana!</p>
      <p class="text-2xl font-bold text-gray-800 mb-2">â° Waktu: <span id="memoryFinalTime" class="text-blue-600">0:00</span></p>
      <p id="memoryScoreMessage" class="text-lg text-gray-700 font-semibold">Hebat sekali!</p>
     </div>
     <div class="space-y-4"><button class="w-full neon-button text-black px-8 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); closeMemoryGameResults(); restartMemoryGame()" style="z-index: 99999 !important;"> ğŸ”„ Main Lagi </button> <button class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-3 rounded-full font-bold transition-all duration-300 transform hover:scale-105" onclick="playSound('click'); closeMemoryGameResults(); showPage('homePage')" style="z-index: 99999 !important;"> ğŸ  Kembali ke Beranda </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Global Variables
        let isAudioPlaying = false;
        let playerName = '';
        let currentSlide = 0;
        let currentQuestionIndex = 0;
        let quizScore = 0;
        let selectedAnswer = null;
        let quizTimer = null;
        let timeLeft = 25 * 60; // 25 minutes in seconds
        let memoryGameStarted = false;
        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moveCount = 0;
        let gameStartTime = null;
        let quizAnswers = []; // Store all quiz answers
        let autoAdvanceTimer = null;
        let memoryGameCards = [];
        let memoryGameFlippedCards = [];
        let memoryGameMatches = 0;
        let memoryGameTime = 0;
        let memoryGameTimer = null;
        
        // Initialize session tracking
        let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let userDevice = detectDevice();
        
        function detectDevice() {
            const userAgent = navigator.userAgent;
            if (/Android/i.test(userAgent)) return 'Android';
            if (/iPhone|iPad|iPod/i.test(userAgent)) return 'iOS';
            if (/Windows Phone/i.test(userAgent)) return 'Windows Phone';
            return 'Desktop';
        }
        
        // Google Sheets tracking - ENHANCED REAL-TIME SYSTEM
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDLMx6TCDXsHOCFUvKID_sXoib3MuIjUuDGNjCBq_XN3RECCtdoYS6UvqMJk41Kp-LkA/exec';
        const DASHBOARD_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDLMx6TCDXsHOCFUvKID_sXoib3MuIjUuDGNjCBq_XN3RECCtdoYS6UvqMJk41Kp-LkA/exec';
        
        // Enhanced tracking with multiple fallback methods and multiple URLs
        function sendToGoogleSheets(action, data = {}) {
            try {
                const payload = {
                    action: action,
                    sessionId: sessionId,
                    playerName: playerName || 'Anonymous',
                    device: userDevice,
                    timestamp: new Date().toISOString(),
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    ...data
                };
                
                console.log('ğŸ“Š Sending to Google Sheets:', action, payload);
                
                // Multiple Apps Script URLs for redundancy
                const trackingUrls = [
                    APPS_SCRIPT_URL, // Primary URL (your provided URL)
                    'https://script.google.com/macros/s/AKfycbzDLMx6TCDXsHOCFUvKID_sXoib3MuIjUuDGNjCBq_XN3RECCtdoYS6UvqMJk41Kp-LkA/exec', // Same URL as backup
                    'https://script.google.com/macros/s/AKfycbzDLMx6TCDXsHOCFUvKID_sXoib3MuIjUuDGNjCBq_XN3RECCtdoYS6UvqMJk41Kp-LkA/exec' // Same URL as third backup
                ];
                
                // Try each URL with POST method
                trackingUrls.forEach((url, index) => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000 + (index * 2000)); // Staggered timeouts
                    
                    fetch(url, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        mode: 'no-cors',
                        signal: controller.signal
                    }).then(() => {
                        clearTimeout(timeoutId);
                        console.log(`âœ… Data sent successfully via POST to URL ${index + 1}`);
                    }).catch((error) => {
                        clearTimeout(timeoutId);
                        console.warn(`âš ï¸ POST failed for URL ${index + 1}:`, error.message);
                        
                        // Fallback to GET method for this URL
                        try {
                            const params = new URLSearchParams();
                            Object.keys(payload).forEach(key => {
                                if (payload[key] !== null && payload[key] !== undefined) {
                                    const value = String(payload[key]);
                                    if (value.length < 2000) { // URL length limit
                                        params.append(key, value);
                                    }
                                }
                            });
                            
                            const getUrl = `${url}?${params.toString()}`;
                            
                            // Use image pixel for GET request (most reliable)
                            const img = new Image();
                            img.onload = () => console.log(`âœ… Data sent via GET (image pixel) to URL ${index + 1}`);
                            img.onerror = () => console.log(`âš ï¸ Image pixel method failed for URL ${index + 1}`);
                            img.src = getUrl;
                            
                            // Also try fetch GET as backup
                            fetch(getUrl, { 
                                method: 'GET', 
                                mode: 'no-cors',
                                cache: 'no-cache'
                            }).then(() => {
                                console.log(`âœ… Data sent via GET (fetch) to URL ${index + 1}`);
                            }).catch(() => {
                                console.log(`âš ï¸ GET fetch failed for URL ${index + 1}`);
                            });
                            
                        } catch (fallbackError) {
                            console.error(`âŒ All methods failed for URL ${index + 1}:`, fallbackError);
                        }
                    });
                });
                
            } catch (error) {
                console.error('âŒ Critical tracking error:', error);
                
                // Emergency fallback - try simple GET request to all URLs
                try {
                    const emergencyUrls = [
                        APPS_SCRIPT_URL,
                        'https://script.google.com/macros/s/AKfycbzDLMx6TCDXsHOCFUvKID_sXoib3MuIjUuDGNjCBq_XN3RECCtdoYS6UvqMJk41Kp-LkA/exec'
                    ];
                    
                    emergencyUrls.forEach((url, index) => {
                        const emergencyUrl = `${url}?action=${encodeURIComponent(action)}&sessionId=${encodeURIComponent(sessionId)}&playerName=${encodeURIComponent(playerName || 'Anonymous')}&timestamp=${encodeURIComponent(new Date().toISOString())}&device=${encodeURIComponent(userDevice)}`;
                        const emergencyImg = new Image();
                        emergencyImg.onload = () => console.log(`ğŸš¨ Emergency tracking sent to URL ${index + 1}`);
                        emergencyImg.onerror = () => console.log(`ğŸ’¥ Emergency tracking failed for URL ${index + 1}`);
                        emergencyImg.src = emergencyUrl;
                    });
                } catch (emergencyError) {
                    console.error('ğŸ’¥ All emergency tracking failed:', emergencyError);
                }
            }
        }
        
        // Enhanced dashboard data loading with better error handling
        async function loadDashboardData(tabName = null) {
            const targetTab = tabName || currentDashboardTab;
            console.log('ğŸ“Š Loading dashboard data for tab:', targetTab);
            
            try {
                // Show loading state
                showLoadingState(targetTab);
                
                // Multiple attempts with different methods
                let response = null;
                let attempts = 0;
                const maxAttempts = 3;
                
                while (!response && attempts < maxAttempts) {
                    attempts++;
                    console.log(`ğŸ”„ Attempt ${attempts}/${maxAttempts} to load dashboard data`);
                    
                    try {
                        // Try with different URL formats
                        const urls = [
                            `${DASHBOARD_SCRIPT_URL}?action=getData&tab=${targetTab}&timestamp=${Date.now()}`,
                            `${DASHBOARD_SCRIPT_URL}?action=getData&tab=${targetTab}`,
                            `${APPS_SCRIPT_URL}?action=getDashboardData&tab=${targetTab}&timestamp=${Date.now()}`,
                            `https://script.google.com/macros/s/AKfycbzDLMx6TCDXsHOCFUvKID_sXoib3MuIjUuDGNjCBq_XN3RECCtdoYS6UvqMJk41Kp-LkA/exec?action=getData&tab=${targetTab}&timestamp=${Date.now()}`
                        ];
                        
                        const currentUrl = urls[attempts - 1];
                        console.log(`ğŸ“¡ Trying URL: ${currentUrl}`);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                        
                        response = await fetch(currentUrl, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        console.log('âœ… Dashboard data response received');
                        break;
                        
                    } catch (attemptError) {
                        console.warn(`âš ï¸ Attempt ${attempts} failed:`, attemptError.message);
                        if (attempts === maxAttempts) {
                            throw attemptError;
                        }
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                
                if (!response) {
                    throw new Error('All connection attempts failed');
                }
                
                const data = await response.json();
                console.log('ğŸ“Š Dashboard data received:', data);
                
                // Validate data structure
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid data format received');
                }
                
                // Update dashboard data
                dashboardData[targetTab] = data.data || [];
                
                // Render the data
                renderDashboardData(targetTab, data.data || []);
                
                // Update last update time
                updateLastUpdateTime(targetTab);
                
                // Update total users count if on users tab
                if (targetTab === 'users') {
                    const userCount = data.data ? data.data.length : 0;
                    document.getElementById('totalUsersCount').textContent = userCount;
                    console.log(`ğŸ‘¥ Total users: ${userCount}`);
                }
                
                console.log('âœ… Dashboard data loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading dashboard data:', error);
                showErrorState(targetTab, error.message);
                
                // Send error tracking
                sendToGoogleSheets('dashboard_load_error', {
                    tab: targetTab,
                    error: error.message,
                    stack: error.stack
                });
            }
        }
        
        // Initialize session with connection test
        sendToGoogleSheets('session_start', {
            userAgent: navigator.userAgent,
            screenResolution: `${screen.width}x${screen.height}`,
            language: navigator.language
        });
        
        // Connection status tracking
        let connectionStatus = {
            mainTracking: false,
            dashboard: false,
            lastTest: null
        };
        
        // Update connection status indicator
        function updateConnectionStatus() {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            
            if (!dot || !text) return;
            
            const isConnected = connectionStatus.mainTracking || connectionStatus.dashboard;
            const bothConnected = connectionStatus.mainTracking && connectionStatus.dashboard;
            
            if (bothConnected) {
                dot.className = 'w-3 h-3 rounded-full bg-green-500';
                text.textContent = 'Online';
                text.className = 'text-xs font-bold text-green-700';
            } else if (isConnected) {
                dot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                text.textContent = 'Partial';
                text.className = 'text-xs font-bold text-yellow-700';
            } else {
                dot.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                text.textContent = 'Offline';
                text.className = 'text-xs font-bold text-red-700';
            }
        }
        
        // Test connection to Google Apps Script on page load
        function testGoogleSheetsConnection() {
            console.log('ğŸ” Testing Google Sheets connection...');
            connectionStatus.lastTest = new Date();
            
            // Reset status
            connectionStatus.mainTracking = false;
            connectionStatus.dashboard = false;
            updateConnectionStatus();
            
            // Test multiple URLs for better reliability
            const testUrls = [
                { name: 'Primary URL', url: APPS_SCRIPT_URL, key: 'mainTracking' },
                { name: 'Dashboard URL', url: DASHBOARD_SCRIPT_URL, key: 'dashboard' },
                { name: 'Backup URL', url: 'https://script.google.com/macros/s/AKfycbzDLMx6TCDXsHOCFUvKID_sXoib3MuIjUuDGNjCBq_XN3RECCtdoYS6UvqMJk41Kp-LkA/execc', key: 'mainTracking' }
            ];
            
            let successCount = 0;
            const totalTests = testUrls.length;
            
            testUrls.forEach(({ name, url, key }, index) => {
                const testPayload = {
                    action: 'connection_test',
                    sessionId: sessionId,
                    testName: name,
                    timestamp: new Date().toISOString(),
                    device: userDevice
                };
                
                // Test POST method
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 6000 + (index * 1000)); // Staggered timeouts
                
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload),
                    mode: 'no-cors',
                    signal: controller.signal
                }).then(() => {
                    clearTimeout(timeoutId);
                    console.log(`âœ… ${name} POST connection: OK`);
                    connectionStatus[key] = true;
                    successCount++;
                    updateConnectionStatus();
                }).catch((error) => {
                    clearTimeout(timeoutId);
                    console.warn(`âš ï¸ ${name} POST connection failed:`, error.message);
                    
                    // Test GET method as fallback
                    const params = new URLSearchParams();
                    Object.keys(testPayload).forEach(k => {
                        if (testPayload[k]) params.append(k, String(testPayload[k]));
                    });
                    const getUrl = `${url}?${params.toString()}`;
                    
                    const img = new Image();
                    img.onload = () => {
                        console.log(`âœ… ${name} GET connection: OK`);
                        connectionStatus[key] = true;
                        successCount++;
                        updateConnectionStatus();
                    };
                    img.onerror = () => {
                        console.error(`âŒ ${name} GET connection: FAILED`);
                        // Don't set to false immediately, let other URLs try
                    };
                    img.src = getUrl;
                });
            });
            
            // Auto-hide connection status after successful connections
            setTimeout(() => {
                if (successCount >= 2 || connectionStatus.mainTracking || connectionStatus.dashboard) {
                    const statusElement = document.getElementById('connectionStatus');
                    if (statusElement) {
                        statusElement.style.opacity = '0.7';
                        statusElement.style.transform = 'scale(0.8)';
                        
                        // Completely hide after another 3 seconds
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 3000);
                    }
                }
            }, 8000);
        }
        
        // Run connection test after page loads
        setTimeout(testGoogleSheetsConnection, 2000);

        // Quiz Questions Data
        const quizQuestions = [
            // Pertanyaan 1.1
            {
                emoji: "ğŸ¨",
                description: "Perhatikan gambar kain corak insang diatas!",
                context: "Pada gambar terdapat dua segitiga, yaitu segitiga dengan garis tepi merah dan segitiga dengan garis tepi hitam. Diketahui panjang sisi alas segitiga merah adalah 12 cm, dan tinggi segitiga merah adalah 8 cm. Segitiga hitam berada di dalam segitiga merah dan sebangun dengan segitiga merah. Panjang sisi alas segitiga hitam adalah 6 cm.",
                subQuestion: "Apa informasi yang belum diketahui dari soal tersebut?",
                image: "https://i.imgur.com/6FTTPjc.png",
                options: ["tinggi segitiga merah", "tinggi segitiga hitam"],
                correct: 1,
                explanation: "Informasi yang belum diketahui adalah tinggi segitiga hitam, karena tinggi segitiga merah sudah diketahui yaitu 8 cm."
            },
            // Pertanyaan 1.2
            {
                emoji: "ğŸ¨",
                description: "Perhatikan gambar kain corak insang diatas!",
                context: "Pada gambar terdapat dua segitiga, yaitu segitiga dengan garis tepi merah dan segitiga dengan garis tepi hitam. Diketahui panjang sisi alas segitiga merah adalah 12 cm, dan tinggi segitiga merah adalah 8 cm. Segitiga hitam berada di dalam segitiga merah dan sebangun dengan segitiga merah. Panjang sisi alas segitiga hitam adalah 6 cm.",
                subQuestion: "Tentukan perbandingan panjang sisi alas segitiga hitam dan panjang sisi alas segitiga merah.",
                image: "https://i.imgur.com/6FTTPjc.png",
                options: ["â…“", "Â½"],
                correct: 1,
                explanation: "Perbandingan alas segitiga hitam terhadap segitiga merah = 6 cm : 12 cm = Â½."
            },
            // Pertanyaan 1.3
            {
                emoji: "ğŸ¨",
                description: "Perhatikan gambar kain corak insang diatas!",
                context: "Pada gambar terdapat dua segitiga, yaitu segitiga dengan garis tepi merah dan segitiga dengan garis tepi hitam. Diketahui panjang sisi alas segitiga merah adalah 12 cm, dan tinggi segitiga merah adalah 8 cm. Segitiga hitam berada di dalam segitiga merah dan sebangun dengan segitiga merah. Panjang sisi alas segitiga hitam adalah 6 cm.",
                subQuestion: "Berapa tinggi segitiga hitam?",
                image: "https://i.imgur.com/6FTTPjc.png",
                options: ["6", "4"],
                correct: 1,
                explanation: "Karena perbandingan sisi = Â½, maka tinggi segitiga hitam = 8 cm Ã— Â½ = 4 cm."
            },
            // Pertanyaan 1.4
            {
                emoji: "ğŸ¨",
                description: "Perhatikan gambar kain corak insang diatas!",
                context: "Pada gambar terdapat dua segitiga, yaitu segitiga dengan garis tepi merah dan segitiga dengan garis tepi hitam. Diketahui panjang sisi alas segitiga merah adalah 12 cm, dan tinggi segitiga merah adalah 8 cm. Segitiga hitam berada di dalam segitiga merah dan sebangun dengan segitiga merah. Panjang sisi alas segitiga hitam adalah 6 cm.",
                subQuestion: "Tentukan perbandingan tinggi segitiga hitam dan tinggi segitiga merah.",
                image: "https://i.imgur.com/6FTTPjc.png",
                options: ["Â¼", "Â½"],
                correct: 1,
                explanation: "Perbandingan tinggi segitiga hitam terhadap segitiga merah = 4 cm : 8 cm = Â½."
            },
            // Pertanyaan 2.1
            {
                emoji: "ğŸ ",
                description: "Perhatikan gambar diatas!",
                context: "Atap rumah adat Melayu berbentuk segitiga sama kaki dengan alas 15 m dan tinggi 9 m. Di bawah atap utama ada segitiga hiasan dengan alas 5 m.",
                subQuestion: "Apakah segitiga hiasan dan segitiga besar merupakan dua segitiga yang sebangun?",
                image: "https://i.imgur.com/3hiKbI9.png",
                options: ["Sebangun", "Tidak sebangun"],
                correct: 0,
                explanation: "Segitiga hiasan dan segitiga besar adalah sebangun karena memiliki bentuk yang sama dan sudut-sudut yang bersesuaian sama besar."
            },
            // Pertanyaan 2.2
            {
                emoji: "ğŸ ",
                description: "Perhatikan gambar diatas!",
                context: "Atap rumah adat Melayu berbentuk segitiga sama kaki dengan alas 15 m dan tinggi 9 m. Di bawah atap utama ada segitiga hiasan dengan alas 5 m.",
                subQuestion: "Apakah benar perbandingan alas segitiga hiasan dan alas segitiga besar adalah seperti gambar berikut?",
                image: "https://i.imgur.com/3hiKbI9.png",
                questionImage: "https://i.imgur.com/rNj3xUZ.png",
                options: ["benar", "salah"],
                correct: 0,
                explanation: "Benar, perbandingan alas segitiga hiasan dan alas segitiga besar = 5 m : 15 m = 1 : 3."
            },
            // Pertanyaan 2.3
            {
                emoji: "ğŸ ",
                description: "Perhatikan gambar diatas!",
                context: "Atap rumah adat Melayu berbentuk segitiga sama kaki dengan alas 15 m dan tinggi 9 m. Di bawah atap utama ada segitiga hiasan dengan alas 5 m.",
                subQuestion: "Tinggi segitiga hiasan adalah â€¦",
                image: "https://i.imgur.com/3hiKbI9.png",
                options: ["6 m", "3 m"],
                correct: 1,
                explanation: "Perbandingan = 5:15 = 1:3, maka tinggi segitiga hiasan = 9 m Ã· 3 = 3 m."
            },
            // Pertanyaan 2.4
            {
                emoji: "ğŸ ",
                description: "Perhatikan gambar diatas!",
                context: "Atap rumah adat Melayu berbentuk segitiga sama kaki dengan alas 15 m dan tinggi 9 m. Di bawah atap utama ada segitiga hiasan dengan alas 5 m.",
                subQuestion: "Apakah perbandingan tinggi segitiga hiasan dan tinggi segitiga besar sama dengan perbandingan alas segitiga hiasan dan alas segitiga besar?",
                image: "https://i.imgur.com/3hiKbI9.png",
                options: ["sama", "tidak sama"],
                correct: 0,
                explanation: "Sama, karena pada bangun sebangun, perbandingan sisi-sisi yang bersesuaian selalu sama."
            },
            // Pertanyaan 3.1
            {
                emoji: "ğŸšª",
                description: "Perhatikan gambar diatas!",
                context: "Pintu rumah adat Melayu tersebut memiliki tinggi 210 cm dan lebar 90 cm. Pada pintu tersebut terdapat panel-panel berbentuk persegi panjang yang sebangun dengan pintu utama. Panel pada pintu memiliki lebar 60 cm.",
                subQuestion: "Apa informasi yang belum diketahui dari soal tersebut?",
                image: "https://i.imgur.com/Z76rW2C.png",
                options: ["tinggi panel", "lebar pintu utama"],
                correct: 0,
                explanation: "Informasi yang belum diketahui adalah tinggi panel, karena lebar pintu utama sudah diketahui yaitu 90 cm."
            },
            // Pertanyaan 3.2
            {
                emoji: "ğŸšª",
                description: "Perhatikan gambar diatas!",
                context: "Pintu rumah adat Melayu tersebut memiliki tinggi 210 cm dan lebar 90 cm. Pada pintu tersebut terdapat panel-panel berbentuk persegi panjang yang sebangun dengan pintu utama. Panel pada pintu memiliki lebar 60 cm.",
                subQuestion: "Perbandingan sisi bersesuaian yang tepat digunakan adalah â€¦",
                image: "https://i.imgur.com/Z76rW2C.png",
                options: ["https://i.imgur.com/FpFnPXB.png", "https://i.imgur.com/8RIOUZ4.png"],
                correct: 0,
                explanation: "Rumus kesebangunan yang tepat adalah perbandingan sisi-sisi yang bersesuaian sama."
            },
            // Pertanyaan 3.3
            {
                emoji: "ğŸšª",
                description: "Perhatikan gambar diatas!",
                context: "Pintu rumah adat Melayu tersebut memiliki tinggi 210 cm dan lebar 90 cm. Pada pintu tersebut terdapat panel-panel berbentuk persegi panjang yang sebangun dengan pintu utama. Panel pada pintu memiliki lebar 60 cm.",
                subQuestion: "Berapa tinggi panel?",
                image: "https://i.imgur.com/Z76rW2C.png",
                options: ["140", "120"],
                correct: 0,
                explanation: "Perbandingan = 60:90 = 2:3, maka tinggi panel = 210 cm Ã— (2/3) = 140 cm."
            },
            // Pertanyaan 3.4
            {
                emoji: "ğŸšª",
                description: "Perhatikan gambar diatas!",
                context: "Pintu rumah adat Melayu tersebut memiliki tinggi 210 cm dan lebar 90 cm. Pada pintu tersebut terdapat panel-panel berbentuk persegi panjang yang sebangun dengan pintu utama. Panel pada pintu memiliki lebar 60 cm.",
                subQuestion: "Apakah perbandingan tinggi panel dan tinggi pintu sama dengan perbandingan lebar panel dan lebar pintu?",
                image: "https://i.imgur.com/Z76rW2C.png",
                options: ["sama", "tidak sama"],
                correct: 0,
                explanation: "Sama, karena pada bangun sebangun, perbandingan sisi-sisi yang bersesuaian selalu sama."
            }
        ];

        // Memory Game Cards Data
        const memoryCardPairs = [
            ['https://i.imgur.com/b1Zlbkt.png', 'https://i.imgur.com/Ejy16gR.png'],
            ['https://i.imgur.com/80ICXOO.png', 'https://i.imgur.com/gcJxB4M.png'],
            ['https://i.imgur.com/Veak9do.png', 'https://i.imgur.com/w12jWLf.png'],
            ['https://i.imgur.com/0fxX71F.png', 'https://i.imgur.com/bsv7VA7.png'],
            ['https://i.imgur.com/hDz2ArX.png', 'https://i.imgur.com/974FBWr.png'],
            ['https://i.imgur.com/2witPyO.png', 'https://i.imgur.com/xte0thx.png']
        ];
        
        const memoryCardData = [];
        memoryCardPairs.forEach((pair, pairIndex) => {
            pair.forEach((imageUrl, cardIndex) => {
                memoryCardData.push({
                    id: pairIndex * 2 + cardIndex + 1,
                    image: imageUrl,
                    pair: pairIndex + 1
                });
            });
        });

        // Audio Control
        function toggleAudio() {
            console.log('Audio button clicked!');
            const audioIcon = document.getElementById('audioIcon');
            const backgroundMusic = document.getElementById('backgroundMusic');
            
            if (isAudioPlaying) {
                // Pause music
                backgroundMusic.pause();
                audioIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>';
                isAudioPlaying = false;
            } else {
                // Play music
                backgroundMusic.play().catch(e => console.log('Audio play failed:', e));
                audioIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>';
                isAudioPlaying = true;
            }
            
            sendToGoogleSheets('audio_toggle', { isPlaying: isAudioPlaying });
        }

        // Page Navigation
        function showPage(pageId) {
            console.log('Navigating to:', pageId);
            
            const pages = ['homePage', 'materialPage', 'nameInputPage', 'quizPage', 'quizResultPage', 'memoryGamePage', 'hostLoginPage', 'hostDashboardPage'];
            pages.forEach(page => {
                const element = document.getElementById(page);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                sendToGoogleSheets('page_view', { page: pageId });
            }
            
            // Control host login button visibility
            const hostLoginBtn = document.getElementById('hostLoginBtn');
            if (hostLoginBtn) {
                if (pageId === 'homePage') {
                    hostLoginBtn.style.display = 'block';
                } else {
                    hostLoginBtn.style.display = 'none';
                }
            }
            
            // Stop dashboard auto-refresh when leaving dashboard page
            if (pageId !== 'hostDashboardPage') {
                stopDashboardAutoRefresh();
            }
        }

        // Material Slide Functions
        let currentMaterialSlide = 1;
        let slideAnswers = {
            slide2: null,
            slide3: null,
            slide4: false
        };
        
        function showMaterialSlide(slideNumber) {
            console.log('Showing material slide:', slideNumber);
            
            // Validate slide number
            if (slideNumber < 1 || slideNumber > 6) return;
            
            // Check if user can access this slide
            if (!canAccessSlide(slideNumber)) {
                showSlideAccessDeniedMessage(slideNumber);
                return;
            }
            
            // Hide all slides
            for (let i = 1; i <= 6; i++) {
                const slide = document.getElementById(`slide${i}`);
                if (slide) slide.classList.add('hidden');
            }
            
            // Show selected slide
            const targetSlide = document.getElementById(`slide${slideNumber}`);
            if (targetSlide) {
                targetSlide.classList.remove('hidden');
            }
            
            // Update indicators - make sure we have the right number
            const indicators = document.querySelectorAll('.slide-indicator');
            indicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'disabled');
                if (index === slideNumber - 1) {
                    indicator.classList.add('active');
                } else if (!canAccessSlide(index + 1)) {
                    indicator.classList.add('disabled');
                }
            });
            
            // Update current slide
            currentMaterialSlide = slideNumber;
            
            // Restore previous answers when navigating back
            restoreSlideAnswers(slideNumber);
            
            // Update navigation buttons
            updateMaterialNavigation();
            
            sendToGoogleSheets('material_slide_view', { slideNumber: slideNumber });
        }

        function nextMaterialSlide() {
            // Check if current slide requires an answer
            if (!canProceedToNextSlide()) {
                showAnswerRequiredMessage();
                return;
            }
            
            if (currentMaterialSlide < 6) {
                const nextSlide = currentMaterialSlide + 1;
                showMaterialSlide(nextSlide);
            }
        }

        function previousMaterialSlide() {
            if (currentMaterialSlide > 1) {
                const prevSlide = currentMaterialSlide - 1;
                showMaterialSlide(prevSlide);
            }
        }

        function canProceedToNextSlide() {
            switch(currentMaterialSlide) {
                case 2:
                    return slideAnswers.slide2 !== null;
                case 3:
                    return slideAnswers.slide3 !== null;
                case 4:
                    return slideAnswers.slide4 === true;
                default:
                    return true;
            }
        }

        function canAccessSlide(slideNumber) {
            // Slide 1 is always accessible
            if (slideNumber === 1) return true;
            
            // For other slides, check if previous slides are completed
            for (let i = 2; i <= slideNumber; i++) {
                switch(i) {
                    case 2:
                        // Can access slide 2 if we're currently on slide 1 or have answered slide 2
                        if (currentMaterialSlide === 1 || slideAnswers.slide2 !== null) continue;
                        return false;
                    case 3:
                        // Can access slide 3 if slide 2 is answered
                        if (slideAnswers.slide2 !== null) continue;
                        return false;
                    case 4:
                        // Can access slide 4 if slide 3 is answered
                        if (slideAnswers.slide3 !== null) continue;
                        return false;
                    case 5:
                        // Can access slide 5 if slide 4 is answered
                        if (slideAnswers.slide4 === true) continue;
                        return false;
                    case 6:
                        // Can access slide 6 if slide 4 is answered (slide 5 doesn't require answer)
                        if (slideAnswers.slide4 === true) continue;
                        return false;
                }
            }
            return true;
        }

        function showSlideAccessDeniedMessage(slideNumber) {
            // Create temporary message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-red-500 to-pink-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-2xl z-50 animate-bounce';
            messageDiv.innerHTML = `ğŸ”’ Selesaikan slide ${slideNumber - 1} dulu ya!`;
            messageDiv.style.zIndex = '99999';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        function updateSlideIndicators() {
            const indicators = document.querySelectorAll('.slide-indicator');
            indicators.forEach((indicator, index) => {
                indicator.classList.remove('disabled');
                if (!canAccessSlide(index + 1)) {
                    indicator.classList.add('disabled');
                }
            });
        }

        function showAnswerRequiredMessage() {
            // Create temporary message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-full font-bold text-lg shadow-2xl z-50 animate-bounce';
            messageDiv.innerHTML = 'âš ï¸ Jawab pertanyaan dulu ya!';
            messageDiv.style.zIndex = '99999';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        function restoreSlideAnswers(slideNumber) {
            if (slideNumber === 2 && slideAnswers.slide2 !== null) {
                // Restore slide 2 answer
                const feedbackDiv = document.getElementById('slide2-feedback');
                const buttonsDiv = document.getElementById('slide2-buttons');
                
                buttonsDiv.classList.add('hidden');
                feedbackDiv.classList.remove('hidden');
                
                if (slideAnswers.slide2 === 'sama') {
                    feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-green-100 to-emerald-100 border-l-4 border-green-500';
                    feedbackDiv.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="text-3xl">âœ…</div>
                            <div>
                                <h5 class="text-lg font-bold text-green-800 mb-2">Ya, kamu benar. Segitiga putih dan segitiga merah memiliki bentuk yang sama</h5>
                                <p class="text-sm text-green-700 mt-2">âœ“ Jawaban tersimpan</p>
                            </div>
                        </div>
                    `;
                } else {
                    feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-red-100 to-pink-100 border-l-4 border-red-500';
                    feedbackDiv.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="text-3xl">âŒ</div>
                            <div>
                                <h5 class="text-lg font-bold text-red-800 mb-2">Belum tepat. Jawaban yang benar adalah segitiga putih dan segitiga merah memiliki bentuk yang sama</h5>
                                <p class="text-sm text-red-700 mt-2">âœ“ Jawaban tersimpan</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            if (slideNumber === 3 && slideAnswers.slide3 !== null) {
                // Restore slide 3 answer
                const feedbackDiv = document.getElementById('slide3-feedback');
                const buttonsDiv = document.getElementById('slide3-buttons');
                const explanationDiv = document.getElementById('slide3-explanation');
                
                buttonsDiv.classList.add('hidden');
                feedbackDiv.classList.remove('hidden');
                explanationDiv.classList.remove('hidden');
                
                if (slideAnswers.slide3 === 'sama') {
                    feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-green-100 to-emerald-100 border-l-4 border-green-500';
                    feedbackDiv.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="text-3xl">âœ…</div>
                            <div>
                                <h5 class="text-lg font-bold text-green-800 mb-2">Ya, kamu benar. Sudut-sudut dan perbandingan sisi-sisi yang bersesuaian sama. Karena segitiga merah terbentuk dari garis yang sejajar dengan alas segitiga putih. Sehingga sudut-sudut yang bersesuaian sama besar. Jika dua segitiga memiliki sudut-sudut yang bersesuaian sama besar, maka sisi-sisi yang bersesuaian memiliki perbandingan yang sama.</h5>
                                <p class="text-sm text-green-700 mt-2">âœ“ Jawaban tersimpan</p>
                            </div>
                        </div>
                    `;
                } else {
                    feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-red-100 to-pink-100 border-l-4 border-red-500';
                    feedbackDiv.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="text-3xl">âŒ</div>
                            <div>
                                <h5 class="text-lg font-bold text-red-800 mb-2">Belum tepat. Jawaban yang benar adalah sudut-sudut dan perbandingan sisi-sisi yang bersesuaian sama. Karena segitiga merah terbentuk dari garis yang sejajar dengan alas segitiga putih. Sehingga sudut-sudut yang bersesuaian sama besar. Jika dua segitiga memiliki sudut-sudut yang bersesuaian sama besar, maka sisi-sisi yang bersesuaian memiliki perbandingan yang sama.</h5>
                                <p class="text-sm text-red-700 mt-2">âœ“ Jawaban tersimpan</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            if (slideNumber === 4 && slideAnswers.slide4 === true) {
                // Restore slide 4 answer
                const feedbackDiv = document.getElementById('slide4Feedback');
                
                // Show feedback but keep textarea editable
                feedbackDiv.classList.remove('hidden');
                feedbackDiv.innerHTML = '<p class="text-green-600 font-semibold text-sm">âœ… Terima kasih atas jawaban Anda! Sekarang Anda bisa melanjutkan ke slide berikutnya.</p>';
            }
        }

        function updateMaterialNavigation() {
            const prevBtn = document.getElementById('materialPrevBtn');
            const nextBtn = document.getElementById('materialNextBtn');
            
            // Update previous button
            if (prevBtn) {
                prevBtn.disabled = currentMaterialSlide === 1;
                if (currentMaterialSlide === 1) {
                    prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // Update next button
            if (nextBtn) {
                if (currentMaterialSlide === 6) {
                    // Last slide - disable next button
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = 'âœ… Selesai';
                    nextBtn.className = 'bg-gradient-to-r from-gray-400 to-gray-500 text-white px-4 py-2 rounded-full font-bold text-sm cursor-not-allowed opacity-50';
                } else {
                    // Check if current slide requires an answer
                    const canProceed = canProceedToNextSlide();
                    nextBtn.disabled = !canProceed;
                    
                    if (!canProceed) {
                        nextBtn.innerHTML = 'ğŸ”’ Jawab Dulu';
                        nextBtn.className = 'bg-gradient-to-r from-gray-400 to-gray-500 text-white px-4 py-2 rounded-full font-bold text-sm cursor-not-allowed opacity-50';
                    } else {
                        nextBtn.innerHTML = 'Selanjutnya â¡ï¸';
                        nextBtn.className = 'neon-button px-4 py-2 rounded-full font-bold text-sm';
                    }
                }
            }
            
            console.log('Navigation updated - Current slide:', currentMaterialSlide, 'Can proceed:', canProceedToNextSlide());
        }

        // Slide 4 Answer Function
        function checkSlide4Answer() {
            const answerText = document.getElementById('slide4Answer').value.trim();
            const feedbackDiv = document.getElementById('slide4Feedback');
            
            if (answerText.length > 0) {
                slideAnswers.slide4 = true;
                feedbackDiv.classList.remove('hidden');
                
                // Update navigation and indicators (but don't lock the textarea)
                updateMaterialNavigation();
                updateSlideIndicators();
                
                sendToGoogleSheets('slide4_answer', { 
                    answer: answerText,
                    length: answerText.length 
                });
            } else {
                feedbackDiv.classList.add('hidden');
                slideAnswers.slide4 = false;
                updateMaterialNavigation();
                updateSlideIndicators();
            }
        }

        // Feature Functions
        function showMaterial() {
            console.log('Material button clicked!');
            
            // Check if user has entered name
            if (!playerName || playerName.trim().length < 2) {
                showNameInputForFeature('material');
                return;
            }
            
            // Reset slide answers when starting material
            slideAnswers = {
                slide2: null,
                slide3: null,
                slide4: false
            };
            
            // Reset current slide to 1
            currentMaterialSlide = 1;
            
            sendToGoogleSheets('material_access');
            showPage('materialPage');
            
            // Small delay to ensure page is shown before slide navigation
            setTimeout(() => {
                showMaterialSlide(1);
            }, 100);
        }

        function showNameInput() {
            console.log('Quiz button clicked!');
            showNameInputForFeature('quiz');
        }

        function showMemoryGame() {
            console.log('Memory game button clicked!');
            
            // Check if user has entered name
            if (!playerName || playerName.trim().length < 2) {
                showNameInputForFeature('memory');
                return;
            }
            
            sendToGoogleSheets('memory_game_access');
            showPage('memoryGamePage');
            initializeMemoryGame();
        }

        function showNameInputForFeature(feature) {
            // Store which feature user wants to access
            window.targetFeature = feature;
            
            // Update the name input page for the specific feature
            updateNameInputPageForFeature(feature);
            
            sendToGoogleSheets('name_input_required', { targetFeature: feature });
            showPage('nameInputPage');
        }

        function updateNameInputPageForFeature(feature) {
            const startBtn = document.getElementById('startQuizBtn');
            const pageTitle = document.querySelector('#nameInputPage h2');
            const pageDescription = document.querySelector('#nameInputPage p');
            
            switch(feature) {
                case 'material':
                    pageTitle.innerHTML = 'ğŸ“– Akses Materi Pembelajaran';
                    pageDescription.textContent = 'Masukkan nama untuk mengakses materi';
                    startBtn.innerHTML = 'ğŸ“š Mulai Belajar Materi';
                    break;
                case 'quiz':
                    pageTitle.innerHTML = 'ğŸ“ Akses Latihan Soal';
                    pageDescription.textContent = 'Masukkan nama untuk mengerjakan quiz';
                    startBtn.innerHTML = 'ğŸš€ Mulai Latihan Soal';
                    break;
                case 'memory':
                    pageTitle.innerHTML = 'ğŸ® Akses Game Cocokin Yuk!';
                    pageDescription.textContent = 'Masukkan nama untuk bermain game';
                    startBtn.innerHTML = 'ğŸ§© Mulai Game Memori';
                    break;
                default:
                    pageTitle.innerHTML = 'ğŸ“ Masukkan Nama';
                    pageDescription.textContent = 'Siapa nama kamu?';
                    startBtn.innerHTML = 'ğŸš€ Mulai Latihan Soal';
            }
        }

        function showHostLogin() {
            console.log('Host login button clicked!');
            sendToGoogleSheets('host_login_access');
            showPage('hostLoginPage');
        }

        // Name Input Functions
        function checkNameInput() {
            const nameInput = document.getElementById('playerName');
            const startBtn = document.getElementById('startQuizBtn');
            
            if (nameInput && startBtn) {
                const name = nameInput.value.trim();
                startBtn.disabled = name.length < 2;
            }
        }

        function startQuizWithName() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (name.length < 2) {
                return;
            }
            
            playerName = name;
            
            // Get the target feature from window object
            const targetFeature = window.targetFeature || 'quiz';
            
            // Navigate to the appropriate feature
            switch(targetFeature) {
                case 'material':
                    // Reset slide answers when starting material
                    slideAnswers = {
                        slide2: null,
                        slide3: null,
                        slide4: false
                    };
                    currentMaterialSlide = 1;
                    
                    sendToGoogleSheets('material_start', { playerName: playerName });
                    showPage('materialPage');
                    
                    setTimeout(() => {
                        showMaterialSlide(1);
                    }, 100);
                    break;
                    
                case 'memory':
                    sendToGoogleSheets('memory_game_start_with_name', { playerName: playerName });
                    showPage('memoryGamePage');
                    initMemoryGame();
                    // Auto-start the game immediately
                    setTimeout(() => {
                        startMemoryGame();
                    }, 500);
                    break;
                    
                case 'quiz':
                default:
                    document.getElementById('playerNameDisplay').textContent = playerName;
                    sendToGoogleSheets('quiz_start', { playerName: playerName });
                    showPage('quizPage');
                    initializeQuiz();
                    break;
            }
            
            // Clear the target feature
            window.targetFeature = null;
        }

        // Quiz Functions
        function initializeQuiz() {
            console.log('Initializing quiz...');
            console.log('Total questions:', quizQuestions.length);
            
            currentQuestionIndex = 0;
            quizScore = 0;
            selectedAnswer = null;
            timeLeft = 25 * 60;
            quizAnswers = []; // Reset quiz answers
            
            // Initialize quiz answers array
            for (let i = 0; i < quizQuestions.length; i++) {
                quizAnswers[i] = null;
            }
            
            document.getElementById('quizCorrectCount').textContent = '0';
            document.getElementById('questionContainer').classList.remove('hidden');
            document.getElementById('quizCompleteScreen').classList.add('hidden');
            
            // Check if restartQuizBtn exists before trying to hide it
            const restartBtn = document.getElementById('restartQuizBtn');
            if (restartBtn) {
                restartBtn.classList.add('hidden');
            }
            
            loadQuestion();
            startQuizTimer();
        }

        function loadQuestion() {
            console.log('Loading question:', currentQuestionIndex, quizQuestions[currentQuestionIndex]);
            const question = quizQuestions[currentQuestionIndex];
            
            if (!question) {
                console.error('Question not found at index:', currentQuestionIndex);
                return;
            }
            
            // Update question title and description
            document.getElementById('quizQuestionTitle').textContent = `Pertanyaan ${currentQuestionIndex + 1}`;
            
            // Update question description
            document.getElementById('quizQuestionDescription').textContent = question.description || "Perhatikan soal berikut!";
            
            // Update question context
            document.getElementById('quizQuestionContext').textContent = question.context || "";
            
            // Update sub question
            document.getElementById('quizSubQuestion').textContent = question.subQuestion || question.question || "";
            
            // Handle main image
            const imageContainer = document.getElementById('quizImageContainer');
            if (question.image) {
                imageContainer.innerHTML = `
                    <img src="${question.image}" alt="Gambar soal" class="max-w-full h-auto mx-auto rounded-lg shadow-lg" style="max-height: 250px;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-6xl mb-4\\'>ğŸ“</div><p class=\\'text-lg font-semibold text-gray-800\\'>Gambar tidak dapat dimuat</p>';">
                `;
            } else {
                imageContainer.innerHTML = `
                    <div class="text-6xl mb-4">${question.emoji || 'ğŸ“'}</div>
                    <p class="text-lg font-semibold text-gray-800">Gambar Soal</p>
                `;
            }
            
            // Handle question-specific image
            const questionImageContainer = document.getElementById('quizQuestionImageContainer');
            if (question.questionImage) {
                questionImageContainer.innerHTML = `
                    <img src="${question.questionImage}" alt="Gambar pertanyaan" class="max-w-full h-auto mx-auto rounded-lg shadow-lg mb-4" style="max-height: 200px;" onerror="this.style.display='none';">
                `;
                questionImageContainer.classList.remove('hidden');
            } else {
                questionImageContainer.classList.add('hidden');
            }
            
            // Create options
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            if (question.options && question.options.length > 0) {
                question.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'quiz-option';
                    button.style.zIndex = '99999';
                    button.style.pointerEvents = 'auto';
                    button.style.cursor = 'pointer';
                    button.style.position = 'relative';
                    
                    // Check if option is an image URL
                    if (option && option.toString().startsWith('https://')) {
                        button.innerHTML = `
                            <span class="font-bold text-blue-600 mr-3">${String.fromCharCode(65 + index)}.</span>
                            <img src="${option}" alt="Pilihan ${String.fromCharCode(65 + index)}" class="inline-block max-h-12 mx-auto" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\\'font-bold text-blue-600 mr-3\\'>${String.fromCharCode(65 + index)}.</span> Gambar tidak dapat dimuat';">
                        `;
                    } else {
                        button.innerHTML = `<span class="font-bold text-blue-600 mr-3">${String.fromCharCode(65 + index)}.</span> ${option || 'Pilihan ' + (index + 1)}`;
                    }
                    
                    button.onclick = () => {
                        console.log('Option clicked:', index, option);
                        selectAnswer(index, String.fromCharCode(65 + index));
                    };
                    
                    optionsContainer.appendChild(button);
                });
            } else {
                console.error('No options found for question:', question);
                optionsContainer.innerHTML = '<p class="text-red-600">Error: Pilihan jawaban tidak ditemukan</p>';
            }
            
            // Reset state
            selectedAnswer = quizAnswers[currentQuestionIndex]; // Get saved answer
            
            const nextBtn = document.getElementById('quizNextBtn');
            if (nextBtn) {
                nextBtn.disabled = selectedAnswer === null;
            }
            
            // Hide auto advance countdown
            const autoAdvanceCountdown = document.getElementById('autoAdvanceCountdown');
            if (autoAdvanceCountdown) {
                autoAdvanceCountdown.classList.add('hidden');
            }
            
            // Clear any existing auto advance timer
            if (autoAdvanceTimer) {
                clearTimeout(autoAdvanceTimer);
                autoAdvanceTimer = null;
            }
            
            // If question was already answered, show the locked state
            if (selectedAnswer !== null) {
                showLockedAnswerState();
            }
            
            updateQuizProgress();
        }
        
        function parseQuestionText(questionText) {
            // Default values
            let description = "Perhatikan soal berikut!";
            let context = "";
            let subQuestion = questionText;
            let questionImage = null;
            
            // Check for specific question patterns
            if (questionText.includes("Perhatikan gambar kain corak insang")) {
                description = "Perhatikan gambar kain corak insang berikut!";
                const parts = questionText.split("Apakah segitiga merah dan segitiga hitam sebangun?");
                if (parts.length > 1) {
                    context = parts[0].replace("Perhatikan gambar kain corak insang berikut!", "").trim();
                    subQuestion = "Apakah segitiga merah dan segitiga hitam sebangun?";
                } else {
                    const contextMatch = questionText.match(/Pada gambar terdapat.*?cm\./);
                    if (contextMatch) {
                        context = contextMatch[0];
                        subQuestion = questionText.replace(contextMatch[0], "").replace("Perhatikan gambar kain corak insang berikut!", "").trim();
                    }
                }
            } else if (questionText.includes("Perhatikan gambar berikut!") && questionText.includes("Atap rumah adat")) {
                description = "Perhatikan gambar berikut!";
                const parts = questionText.split(/Apa yang ditanyakan|Segitiga hiasan|Perbandingan alas|Tinggi segitiga/);
                if (parts.length > 1) {
                    context = parts[0].replace("Perhatikan gambar berikut!", "").trim();
                    subQuestion = questionText.replace(parts[0], "").trim();
                }
                if (questionText.includes("Perbandingan alas kedua segitiga")) {
                    questionImage = "https://i.imgur.com/2GcWm8J.jpg";
                }
            } else if (questionText.includes("Pintu rumah adat Melayu")) {
                description = "Perhatikan gambar berikut!";
                const parts = questionText.split(/Apa yang ditanyakan|Rumus kesebangunan|Berapa tinggi|Apakah benar/);
                if (parts.length > 1) {
                    context = parts[0].replace("Perhatikan gambar berikut.", "").trim();
                    subQuestion = questionText.replace(parts[0], "").trim();
                }
                if (questionText.includes("Rumus kesebangunan")) {
                    // Add images for formula options
                    questionImage = "https://i.imgur.com/FpFnPXB.jpg";
                }
            }
            
            return {
                description,
                context,
                subQuestion,
                questionImage
            };
        }

        function selectAnswer(answerIndex, answerLetter) {
            if (selectedAnswer !== null) return; // Already answered, can't change
            
            selectedAnswer = answerIndex;
            quizAnswers[currentQuestionIndex] = answerIndex; // Save answer
            
            const question = quizQuestions[currentQuestionIndex];
            const options = document.querySelectorAll('.quiz-option');
            
            options.forEach((option, index) => {
                option.classList.remove('selected');
                if (index === answerIndex) {
                    option.classList.add('selected');
                }
            });
            
            setTimeout(() => {
                options.forEach((option, index) => {
                    if (index === question.correct) {
                        option.classList.add('correct');
                    } else if (index === answerIndex && answerIndex !== question.correct) {
                        option.classList.add('incorrect');
                    }
                });
                
                if (answerIndex === question.correct) {
                    quizScore += 10;
                    const correctCount = Math.floor(quizScore / 10);
                    document.getElementById('quizCorrectCount').textContent = correctCount;
                    
                    // Show correct popup and auto-hide after 2 seconds
                    document.getElementById('quizCorrectPopup').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('quizCorrectPopup').classList.add('hidden');
                    }, 2000);
                } else {
                    // Show incorrect popup and auto-hide after 2 seconds
                    document.getElementById('quizIncorrectPopup').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('quizIncorrectPopup').classList.add('hidden');
                    }, 2000);
                }
                
                document.getElementById('quizNextBtn').disabled = false;
                
                // Start auto-advance countdown after showing feedback
                startAutoAdvance();
                
                sendToGoogleSheets('quiz_answer', {
                    questionIndex: currentQuestionIndex,
                    selectedAnswer: answerLetter,
                    correctAnswer: String.fromCharCode(65 + question.correct),
                    isCorrect: answerIndex === question.correct,
                    score: quizScore
                });
            }, 1000);
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= quizQuestions.length) {
                // Auto-complete quiz when all questions are answered
                setTimeout(() => {
                    completeQuiz();
                }, 2000); // Wait 2 seconds after last answer feedback
            } else {
                loadQuestion();
            }
        }

        function startAutoAdvance() {
            // Clear any existing timer
            if (autoAdvanceTimer) {
                clearInterval(autoAdvanceTimer);
                autoAdvanceTimer = null;
            }
            
            // On last question, show completion message and auto-complete
            if (currentQuestionIndex >= quizQuestions.length - 1) {
                const autoAdvanceCountdown = document.getElementById('autoAdvanceCountdown');
                if (autoAdvanceCountdown) {
                    autoAdvanceCountdown.innerHTML = `
                        <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-xl border-2 border-green-300">
                            <div class="text-lg font-bold text-green-800 mb-2">
                                ğŸ‰ Quiz akan selesai otomatis dalam <span id="countdownTimer" class="text-blue-600">2</span> detik
                            </div>
                            <div class="text-sm text-green-700">Menuju halaman hasil...</div>
                        </div>
                    `;
                    autoAdvanceCountdown.classList.remove('hidden');
                }
                
                // Auto-complete quiz after 2 seconds
                let timeLeft = 2;
                const newCountdownTimer = document.getElementById('countdownTimer');
                if (newCountdownTimer) {
                    newCountdownTimer.textContent = timeLeft;
                }
                
                autoAdvanceTimer = setInterval(() => {
                    timeLeft--;
                    const currentCountdownTimer = document.getElementById('countdownTimer');
                    if (currentCountdownTimer) {
                        currentCountdownTimer.textContent = timeLeft;
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(autoAdvanceTimer);
                        autoAdvanceTimer = null;
                        if (autoAdvanceCountdown) {
                            autoAdvanceCountdown.classList.add('hidden');
                        }
                        completeQuiz();
                    }
                }, 1000);
                
                return;
            }
            
            // Show countdown for other questions
            const autoAdvanceCountdown = document.getElementById('autoAdvanceCountdown');
            const countdownTimer = document.getElementById('countdownTimer');
            
            if (!autoAdvanceCountdown || !countdownTimer) {
                return;
            }
            
            autoAdvanceCountdown.innerHTML = `
                <div class="bg-gradient-to-r from-orange-100 to-red-100 p-4 rounded-xl border-2 border-orange-300">
                    <div class="text-lg font-bold text-orange-800 mb-2">
                        â° Otomatis lanjut dalam <span id="countdownTimer" class="text-red-600">5</span> detik
                    </div>
                    <div class="text-sm text-orange-700">Klik "Selanjutnya" untuk lanjut sekarang</div>
                </div>
            `;
            autoAdvanceCountdown.classList.remove('hidden');
            
            let timeLeft = 5;
            const newCountdownTimer = document.getElementById('countdownTimer');
            if (newCountdownTimer) {
                newCountdownTimer.textContent = timeLeft;
            }
            
            // Use setInterval for countdown and store it properly
            autoAdvanceTimer = setInterval(() => {
                timeLeft--;
                const currentCountdownTimer = document.getElementById('countdownTimer');
                if (currentCountdownTimer) {
                    currentCountdownTimer.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(autoAdvanceTimer);
                    autoAdvanceTimer = null;
                    if (autoAdvanceCountdown) {
                        autoAdvanceCountdown.classList.add('hidden');
                    }
                    nextQuestion();
                }
            }, 1000);
        }

        function showLockedAnswerState() {
            const question = quizQuestions[currentQuestionIndex];
            const options = document.querySelectorAll('.quiz-option');
            
            options.forEach((option, index) => {
                // Disable all options
                option.style.pointerEvents = 'none';
                option.style.cursor = 'not-allowed';
                option.style.opacity = '0.7';
                
                // Show the selected answer
                if (index === selectedAnswer) {
                    option.classList.add('selected');
                }
                
                // Show correct/incorrect styling
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedAnswer && selectedAnswer !== question.correct) {
                    option.classList.add('incorrect');
                }
            });
            
            // Add locked indicator
            const optionsContainer = document.getElementById('quizOptions');
            let lockedIndicator = optionsContainer.querySelector('.locked-indicator');
            if (!lockedIndicator) {
                lockedIndicator = document.createElement('div');
                lockedIndicator.className = 'locked-indicator text-center mt-4 p-3 bg-gray-100 rounded-lg border-2 border-gray-300';
                lockedIndicator.innerHTML = `
                    <div class="text-2xl mb-2">ğŸ”’</div>
                    <p class="text-gray-700 font-semibold">Jawaban sudah dikunci</p>
                    <p class="text-sm text-gray-600">Tidak bisa mengubah jawaban yang sudah dipilih</p>
                `;
                optionsContainer.appendChild(lockedIndicator);
            }
        }

        function nextQuizQuestion() {
            // Clear auto advance timer if user manually advances
            if (autoAdvanceTimer) {
                clearInterval(autoAdvanceTimer);
                autoAdvanceTimer = null;
            }
            
            // Hide countdown
            const autoAdvanceCountdown = document.getElementById('autoAdvanceCountdown');
            if (autoAdvanceCountdown) {
                autoAdvanceCountdown.classList.add('hidden');
            }
            
            nextQuestion();
        }

        function previousQuizQuestion() {
            if (currentQuestionIndex > 0) {
                // Clear auto advance timer
                if (autoAdvanceTimer) {
                    clearInterval(autoAdvanceTimer);
                    autoAdvanceTimer = null;
                }
                
                // Hide countdown
                const autoAdvanceCountdown = document.getElementById('autoAdvanceCountdown');
                if (autoAdvanceCountdown) {
                    autoAdvanceCountdown.classList.add('hidden');
                }
                
                currentQuestionIndex--;
                loadQuestion();
                updateQuizProgress();
            }
        }

        function confirmExitQuiz() {
            document.getElementById('quizExitModal').classList.remove('hidden');
        }

        function exitQuiz() {
            clearInterval(quizTimer);
            document.getElementById('quizExitModal').classList.add('hidden');
            showPage('homePage');
            sendToGoogleSheets('quiz_exit', { 
                questionIndex: currentQuestionIndex,
                score: quizScore 
            });
        }

        function closeExitQuiz() {
            document.getElementById('quizExitModal').classList.add('hidden');
        }

        function updateQuizProgress() {
            document.getElementById('quizProgress2').textContent = currentQuestionIndex + 1;
            
            const prevBtn = document.getElementById('quizPrevBtn');
            if (prevBtn) {
                prevBtn.disabled = currentQuestionIndex === 0;
            }
        }

        function completeQuiz() {
            clearInterval(quizTimer);
            
            const correctCount = Math.floor(quizScore / 10);
            const wrongCount = quizQuestions.length - correctCount;
            const percentage = Math.round((correctCount / quizQuestions.length) * 100);
            
            // Calculate total time used
            const totalTime = (25 * 60) - timeLeft;
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Set result content based on percentage
            let message = '';
            let emoji = '';
            let title = '';
            
            if (percentage >= 90) {
                title = 'Luar Biasa!';
                emoji = 'ğŸ†';
                message = 'Kamu menguasai materi kesebangunan dengan sangat baik!';
            } else if (percentage >= 80) {
                title = 'Hebat!';
                emoji = 'ğŸ‰';
                message = 'Pemahaman kamu tentang kesebangunan sudah bagus!';
            } else if (percentage >= 70) {
                title = 'Bagus!';
                emoji = 'ğŸ‘';
                message = 'Kamu sudah memahami konsep dasar kesebangunan!';
            } else if (percentage >= 60) {
                title = 'Cukup Baik!';
                emoji = 'ğŸ“š';
                message = 'Terus belajar untuk memahami kesebangunan lebih baik!';
            } else {
                title = 'Semangat!';
                emoji = 'ğŸ’ª';
                message = 'Jangan menyerah! Coba pelajari materi lagi dan ulangi quiz!';
            }
            
            // Update modal content
            document.getElementById('quizResultEmoji').textContent = emoji;
            document.getElementById('quizResultTitle').textContent = title;
            document.getElementById('quizFinalScore').textContent = correctCount;
            document.getElementById('quizTotalQuestions').textContent = quizQuestions.length;
            // Update percentage with dynamic color
            const percentageElement = document.getElementById('quizFinalPercentage');
            percentageElement.textContent = percentage + '%';
            
            // Set color based on percentage
            if (percentage >= 80) {
                percentageElement.className = 'text-green-600';
            } else if (percentage >= 60) {
                percentageElement.className = 'text-yellow-600';
            } else {
                percentageElement.className = 'text-red-600';
            }
            document.getElementById('quizFinalTime').textContent = timeString;
            document.getElementById('quizScoreMessage').textContent = message;
            
            // Show modal instead of navigating to result page
            document.getElementById('quizResultsModal').classList.remove('hidden');
            
            sendToGoogleSheets('quiz_complete', {
                finalScore: quizScore,
                correctAnswers: correctCount,
                wrongAnswers: wrongCount,
                percentage: percentage,
                timeUsed: 25 * 60 - timeLeft
            });
        }

        function closeQuizResults() {
            document.getElementById('quizResultsModal').classList.add('hidden');
        }

        function restartQuiz() {
            initializeQuiz();
        }

        function startQuiz() {
            // Navigate back to quiz page and restart
            showPage('quizPage');
            initializeQuiz();
        }

        function startQuizTimer() {
            quizTimer = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('quizTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    completeQuiz();
                }
            }, 1000);
        }

        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / quizQuestions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Memory Game Functions
        function showMemoryGame() {
            console.log('Memory game button clicked!');
            
            // Always check if name is entered, regardless of previous input
            const nameInput = document.getElementById('playerName');
            const currentName = nameInput ? nameInput.value.trim() : playerName;
            
            if (!currentName || currentName.length < 2) {
                showNameInputForFeature('memory');
                return;
            }
            
            // Update playerName if it was entered in the input
            if (currentName && currentName !== playerName) {
                playerName = currentName;
            }
            
            sendToGoogleSheets('memory_game_access');
            showPage('memoryGamePage');
            initMemoryGame();
            
            // Auto-start the game immediately
            setTimeout(() => {
                startMemoryGame();
            }, 500);
        }

        function initMemoryGame() {
            // Track memory game start
            sendToGoogleSheets('memory_game_start', {
                feature: 'cocokin_yuk',
                totalPairs: 6
            });
            
            memoryGameCards = [];
            
            // Create cards from pairs
            memoryCardPairs.forEach((pair, pairIndex) => {
                memoryGameCards.push(
                    { id: pairIndex + 1, image: pair[0], matched: false },
                    { id: pairIndex + 1, image: pair[1], matched: false }
                );
            });
            
            // Shuffle cards
            memoryGameCards = shuffleArray(memoryGameCards);
            
            // Reset game state
            memoryGameFlippedCards = [];
            memoryGameMatches = 0;
            memoryGameTime = 0;
            memoryGameStarted = false;
            matchedPairs = 0;
            moveCount = 0;
            
            // Create game board
            createMemoryGameBoard();
            
            // Reset stats display
            updateMemoryGameStats();
            document.getElementById('memoryGameTimer').textContent = '0:00';
            document.getElementById('gameCompleteMessage').classList.add('hidden');
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function createMemoryGameBoard() {
            const board = document.getElementById('memoryGameBoard');
            if (!board) return;
            
            board.innerHTML = '';
            
            memoryGameCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'memory-card';
                cardElement.innerHTML = `
                    <div class="card-front" style="display: none;">
                        <img src="${card.image}" alt="Rebana ${index + 1}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.src=''; this.alt='Rebana ${index + 1}'; this.style.display='none';">
                    </div>
                    <div class="card-back" style="display: flex; align-items: center; justify-content: center;">
                        <img src="https://i.imgur.com/HUKC9Y7.png" alt="Cover Game" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.src=''; this.alt='Cover Game'; this.style.display='none';">
                    </div>
                `;
                cardElement.onclick = () => flipMemoryCard(index);
                board.appendChild(cardElement);
            });
        }

        function startMemoryGame() {
            if (memoryGameStarted) return;
            
            memoryGameStarted = true;
            gameStartTime = Date.now();
            memoryGameFlippedCards = [];
            matchedPairs = 0;
            moveCount = 0;
            
            updateMemoryGameStats();
            startGameTimer();
            
            sendToGoogleSheets('memory_game_started');
        }

        function flipMemoryCard(cardIndex) {
            if (!memoryGameStarted) {
                startMemoryGame();
            }
            
            if (memoryGameFlippedCards.length >= 2) return;
            if (memoryGameFlippedCards.includes(cardIndex)) return;
            if (memoryGameCards[cardIndex].matched) return;
            
            const cardElement = document.querySelectorAll('.memory-card')[cardIndex];
            const cardFront = cardElement.querySelector('.card-front');
            const cardBack = cardElement.querySelector('.card-back');
            
            // Flip card to show front
            cardBack.style.display = 'none';
            cardFront.style.display = 'flex';
            cardFront.style.alignItems = 'center';
            cardFront.style.justifyContent = 'center';
            
            cardElement.classList.add('flipped');
            memoryGameFlippedCards.push(cardIndex);
            
            if (memoryGameFlippedCards.length === 2) {
                moveCount++;
                updateMemoryGameStats();
                setTimeout(() => checkMemoryMatch(), 1000);
            }
        }

        function checkMemoryMatch() {
            const [first, second] = memoryGameFlippedCards;
            const firstCard = memoryGameCards[first];
            const secondCard = memoryGameCards[second];
            
            if (firstCard.id === secondCard.id) {
                // Match found
                const cardElements = document.querySelectorAll('.memory-card');
                cardElements[first].classList.add('matched');
                cardElements[second].classList.add('matched');
                
                memoryGameCards[first].matched = true;
                memoryGameCards[second].matched = true;
                
                matchedPairs++;
                updateMemoryGameStats();
                
                // Track match found
                sendToGoogleSheets('memory_game_match', {
                    matchNumber: matchedPairs,
                    pairId: firstCard.id,
                    currentTime: Math.floor((Date.now() - gameStartTime) / 1000),
                    feature: 'cocokin_yuk'
                });
                
                playSound('correct');
                
                if (matchedPairs === 6) {
                    setTimeout(() => completeMemoryGame(), 500);
                }
            } else {
                // No match - flip cards back
                const cardElements = document.querySelectorAll('.memory-card');
                
                [first, second].forEach(index => {
                    const cardElement = cardElements[index];
                    const cardFront = cardElement.querySelector('.card-front');
                    const cardBack = cardElement.querySelector('.card-back');
                    
                    cardFront.style.display = 'none';
                    cardBack.style.display = 'flex';
                    cardElement.classList.remove('flipped');
                });
                
                playSound('incorrect');
            }
            
            memoryGameFlippedCards = [];
        }

        function completeMemoryGame() {
            clearInterval(memoryGameTimer);
            
            const gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
            const minutes = Math.floor(gameTime / 60);
            const seconds = gameTime % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update modal content
            document.getElementById('memoryFinalTime').textContent = timeString;
            
            let emoji = 'ğŸ‰';
            let message = 'Hebat sekali!';
            
            if (gameTime <= 60) {
                emoji = 'ğŸ†';
                message = 'Luar biasa! Kamu sangat cepat!';
            } else if (gameTime <= 120) {
                emoji = 'â­';
                message = 'Bagus sekali! Waktu yang baik!';
            } else if (gameTime <= 180) {
                emoji = 'ğŸ‘';
                message = 'Hebat! Terus berlatih ya!';
            }
            
            document.getElementById('memoryResultEmoji').textContent = emoji;
            document.getElementById('memoryScoreMessage').textContent = message;
            
            // Show modal instead of inline message
            document.getElementById('memoryGameResultsModal').classList.remove('hidden');
            
            sendToGoogleSheets('memory_game_complete', {
                timeSeconds: gameTime,
                emoji: emoji,
                feature: 'cocokin_yuk'
            });
            
            playSound('complete');
        }

        function closeMemoryGameResults() {
            document.getElementById('memoryGameResultsModal').classList.add('hidden');
        }

        function resetMemoryGame() {
            if (memoryGameTimer) {
                clearInterval(memoryGameTimer);
            }
            memoryGameStarted = false;
            document.getElementById('gameCompleteMessage').classList.add('hidden');
            initMemoryGame();
        }

        function updateMemoryGameStats() {
            document.getElementById('memoryGameMatches').textContent = matchedPairs;
        }

        function updateGameStats() {
            document.getElementById('matchedPairs').textContent = matchedPairs;
        }

        function startGameTimer() {
            const startTime = Date.now();
            memoryGameTimer = setInterval(() => {
                if (matchedPairs === 6) {
                    clearInterval(memoryGameTimer);
                    return;
                }
                
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('memoryGameTimer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Host Login
        function loginHost() {
            const passwordInput = document.getElementById('hostPassword');
            const password = passwordInput.value;
            
            // Clear any existing error message
            const existingError = document.getElementById('passwordError');
            if (existingError) {
                existingError.remove();
            }
            
            if (password === 'host123') {
                sendToGoogleSheets('host_login_success');
                showPage('hostDashboardPage');
                
                // Initialize dashboard
                setTimeout(() => {
                    loadDashboardData('users');
                    startDashboardAutoRefresh();
                }, 500);
            } else {
                sendToGoogleSheets('host_login_failed');
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.id = 'passwordError';
                errorDiv.className = 'mt-4 p-4 bg-gradient-to-r from-red-100 to-pink-100 border-l-4 border-red-500 rounded-lg animate-bounce';
                errorDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">âŒ</div>
                        <div>
                            <h4 class="text-lg font-bold text-red-800">Password Salah!</h4>
                            <p class="text-sm text-red-700">Silakan coba lagi dengan password yang benar.</p>
                        </div>
                    </div>
                `;
                
                // Insert error message after the input field
                const inputContainer = passwordInput.parentElement;
                inputContainer.appendChild(errorDiv);
                
                // Clear password field and focus
                passwordInput.value = '';
                passwordInput.focus();
                
                // Auto-remove error message after 5 seconds
                setTimeout(() => {
                    if (errorDiv && errorDiv.parentElement) {
                        errorDiv.remove();
                    }
                }, 5000);
            }
        }

        function logoutHost() {
            console.log('Host logout clicked!');
            
            // Stop dashboard auto-refresh
            stopDashboardAutoRefresh();
            
            // Clear password field
            const passwordInput = document.getElementById('hostPassword');
            if (passwordInput) {
                passwordInput.value = '';
            }
            
            // Clear any error messages
            const existingError = document.getElementById('passwordError');
            if (existingError) {
                existingError.remove();
            }
            
            // Reset dashboard tab to users
            currentDashboardTab = 'users';
            
            // Track logout
            sendToGoogleSheets('host_logout');
            
            // Show logout confirmation message
            showNotification('ğŸ‘‹ Host berhasil logout!', 'success');
            
            // Navigate back to home page
            showPage('homePage');
        }

        // Slide 1 Popup Functions
        function showSlide1Popup() {
            console.log('Showing slide 1 answer popup');
            document.getElementById('slide1PopupModal').classList.remove('hidden');
            sendToGoogleSheets('slide1_answer_viewed');
        }

        function hideSlide1Popup() {
            console.log('Closing slide 1 answer popup');
            document.getElementById('slide1PopupModal').classList.add('hidden');
        }

        // Quiz Popup Functions
        function closeQuizPopup() {
            document.getElementById('quizCorrectPopup').classList.add('hidden');
            document.getElementById('quizIncorrectPopup').classList.add('hidden');
        }

        // Slide 2 Answer Function
        function answerSlide2(answer) {
            console.log('Slide 2 answer:', answer);
            
            // Save answer
            slideAnswers.slide2 = answer;
            
            const feedbackDiv = document.getElementById('slide2-feedback');
            const buttonsDiv = document.getElementById('slide2-buttons');
            
            // Hide buttons
            buttonsDiv.classList.add('hidden');
            
            // Show feedback
            feedbackDiv.classList.remove('hidden');
            
            if (answer === 'sama') {
                feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-green-100 to-emerald-100 border-l-4 border-green-500';
                feedbackDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-3xl">âœ…</div>
                        <div>
                            <h5 class="text-lg font-bold text-green-800 mb-2">Ya, kamu benar. Segitiga putih dan segitiga merah memiliki bentuk yang sama</h5>
                            <p class="text-sm text-green-700 mt-2">âœ“ Jawaban tersimpan</p>
                        </div>
                    </div>
                `;
            } else {
                feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-red-100 to-pink-100 border-l-4 border-red-500';
                feedbackDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-3xl">âŒ</div>
                        <div>
                            <h5 class="text-lg font-bold text-red-800 mb-2">Belum tepat. Jawaban yang benar adalah segitiga putih dan segitiga merah memiliki bentuk yang sama</h5>
                            <p class="text-sm text-red-700 mt-2">âœ“ Jawaban tersimpan</p>
                        </div>
                    </div>
                `;
            }
            
            // Update navigation and indicators immediately
            updateMaterialNavigation();
            updateSlideIndicators();
            
            sendToGoogleSheets('slide2_answer', { 
                answer: answer, 
                isCorrect: answer === 'sama' 
            });
        }

        // Slide 3 Answer Function
        function answerSlide3(answer) {
            console.log('Slide 3 answer:', answer);
            
            // Save answer
            slideAnswers.slide3 = answer;
            
            const feedbackDiv = document.getElementById('slide3-feedback');
            const buttonsDiv = document.getElementById('slide3-buttons');
            const explanationDiv = document.getElementById('slide3-explanation');
            
            // Hide buttons
            buttonsDiv.classList.add('hidden');
            
            // Show feedback
            feedbackDiv.classList.remove('hidden');
            
            if (answer === 'sama') {
                feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-green-100 to-emerald-100 border-l-4 border-green-500';
                feedbackDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-3xl">âœ…</div>
                        <div>
                            <h5 class="text-lg font-bold text-green-800 mb-2">Ya, kamu benar. Sudut-sudut dan perbandingan sisi-sisi yang bersesuaian sama. Karena segitiga merah terbentuk dari garis yang sejajar dengan alas segitiga putih. Sehingga sudut-sudut yang bersesuaian sama besar. Jika dua segitiga memiliki sudut-sudut yang bersesuaian sama besar, maka sisi-sisi yang bersesuaian memiliki perbandingan yang sama.</h5>
                            <p class="text-sm text-green-700 mt-2">âœ“ Jawaban tersimpan</p>
                        </div>
                    </div>
                `;
            } else {
                feedbackDiv.className = 'mt-6 p-4 rounded-lg bg-gradient-to-r from-red-100 to-pink-100 border-l-4 border-red-500';
                feedbackDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-3xl">âŒ</div>
                        <div>
                            <h5 class="text-lg font-bold text-red-800 mb-2">Belum tepat. Jawaban yang benar adalah sudut-sudut dan perbandingan sisi-sisi yang bersesuaian sama. Karena segitiga merah terbentuk dari garis yang sejajar dengan alas segitiga putih. Sehingga sudut-sudut yang bersesuaian sama besar. Jika dua segitiga memiliki sudut-sudut yang bersesuaian sama besar, maka sisi-sisi yang bersesuaian memiliki perbandingan yang sama.</h5>
                            <p class="text-sm text-red-700 mt-2">âœ“ Jawaban tersimpan</p>
                        </div>
                    </div>
                `;
            }
            
            // Always show explanation image (both for correct and incorrect answers)
            explanationDiv.classList.remove('hidden');
            
            // Update navigation and indicators immediately
            updateMaterialNavigation();
            updateSlideIndicators();
            
            sendToGoogleSheets('slide3_answer', { 
                answer: answer, 
                isCorrect: answer === 'sama' 
            });
        }



        // Enhanced Sound Effects - More Exciting!
        function playSound(soundType) {
            console.log('Playing sound:', soundType);
            
            // Create audio context for sound effects
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Set sound parameters based on type
                switch(soundType) {
                    case 'click':
                        // Energetic pop sound with multiple layers
                        createMultiLayerSound(audioContext, [
                            { freq: 1200, startTime: 0, duration: 0.08, volume: 0.15, type: 'square' },
                            { freq: 800, startTime: 0.02, duration: 0.06, volume: 0.12, type: 'sine' },
                            { freq: 1600, startTime: 0.04, duration: 0.04, volume: 0.08, type: 'triangle' }
                        ]);
                        break;
                        
                    case 'correct':
                        // Super happy celebration sound with chord progression
                        const correctChord = [
                            { freq: 523, startTime: 0, duration: 0.4, volume: 0.2, type: 'sine' },      // C5
                            { freq: 659, startTime: 0.1, duration: 0.4, volume: 0.18, type: 'sine' },   // E5
                            { freq: 784, startTime: 0.2, duration: 0.4, volume: 0.16, type: 'sine' },   // G5
                            { freq: 1047, startTime: 0.3, duration: 0.3, volume: 0.14, type: 'sine' },  // C6
                            { freq: 1319, startTime: 0.35, duration: 0.25, volume: 0.12, type: 'triangle' }, // E6
                            { freq: 1568, startTime: 0.4, duration: 0.2, volume: 0.1, type: 'square' }   // G6
                        ];
                        
                        // Add sparkle effects
                        for (let i = 0; i < 8; i++) {
                            correctChord.push({
                                freq: 2000 + Math.random() * 1000,
                                startTime: 0.1 + i * 0.05,
                                duration: 0.08,
                                volume: 0.06,
                                type: 'sine'
                            });
                        }
                        
                        createMultiLayerSound(audioContext, correctChord);
                        break;
                        
                    case 'incorrect':
                        // Dramatic but encouraging "try again" sound
                        createMultiLayerSound(audioContext, [
                            { freq: 400, startTime: 0, duration: 0.15, volume: 0.18, type: 'sawtooth' },
                            { freq: 300, startTime: 0.05, duration: 0.2, volume: 0.15, type: 'square' },
                            { freq: 250, startTime: 0.1, duration: 0.25, volume: 0.12, type: 'sine' },
                            // Add a hopeful rising note at the end
                            { freq: 350, startTime: 0.3, duration: 0.15, volume: 0.1, type: 'sine' },
                            { freq: 450, startTime: 0.35, duration: 0.1, volume: 0.08, type: 'triangle' }
                        ]);
                        break;
                        
                    case 'complete':
                        // Epic victory fanfare with multiple instruments
                        const victoryFanfare = [
                            // Main melody - triumphant
                            { freq: 523, startTime: 0, duration: 0.3, volume: 0.25, type: 'square' },    // C5
                            { freq: 659, startTime: 0.15, duration: 0.3, volume: 0.23, type: 'square' }, // E5
                            { freq: 784, startTime: 0.3, duration: 0.3, volume: 0.21, type: 'square' },  // G5
                            { freq: 1047, startTime: 0.45, duration: 0.4, volume: 0.28, type: 'square' }, // C6
                            
                            // Harmony layer
                            { freq: 392, startTime: 0.1, duration: 0.4, volume: 0.15, type: 'sine' },   // G4
                            { freq: 494, startTime: 0.25, duration: 0.4, volume: 0.15, type: 'sine' },  // B4
                            { freq: 659, startTime: 0.4, duration: 0.4, volume: 0.15, type: 'sine' },   // E5
                            
                            // Bass line
                            { freq: 131, startTime: 0, duration: 0.6, volume: 0.2, type: 'sawtooth' },  // C3
                            { freq: 196, startTime: 0.3, duration: 0.5, volume: 0.18, type: 'sawtooth' }, // G3
                            
                            // Sparkle effects throughout
                            { freq: 2093, startTime: 0.1, duration: 0.1, volume: 0.08, type: 'sine' },
                            { freq: 2349, startTime: 0.2, duration: 0.1, volume: 0.08, type: 'sine' },
                            { freq: 2637, startTime: 0.3, duration: 0.1, volume: 0.08, type: 'sine' },
                            { freq: 3136, startTime: 0.4, duration: 0.1, volume: 0.08, type: 'sine' },
                            { freq: 3520, startTime: 0.5, duration: 0.15, volume: 0.1, type: 'sine' }
                        ];
                        
                        // Add random sparkles for extra excitement
                        for (let i = 0; i < 12; i++) {
                            victoryFanfare.push({
                                freq: 1500 + Math.random() * 2000,
                                startTime: Math.random() * 0.8,
                                duration: 0.05 + Math.random() * 0.1,
                                volume: 0.04 + Math.random() * 0.04,
                                type: 'sine'
                            });
                        }
                        
                        createMultiLayerSound(audioContext, victoryFanfare);
                        break;
                        
                    default:
                        // Enhanced default click sound
                        createMultiLayerSound(audioContext, [
                            { freq: 800, startTime: 0, duration: 0.1, volume: 0.12, type: 'sine' },
                            { freq: 1200, startTime: 0.02, duration: 0.08, volume: 0.08, type: 'triangle' }
                        ]);
                }
            } catch (error) {
                console.log('Sound effect failed:', error);
            }
        }
        
        // Helper function to create multi-layered sounds
        function createMultiLayerSound(audioContext, soundLayers) {
            soundLayers.forEach(layer => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Set oscillator type
                oscillator.type = layer.type || 'sine';
                
                // Set frequency (with slight vibrato for more life)
                oscillator.frequency.setValueAtTime(layer.freq, audioContext.currentTime + layer.startTime);
                if (layer.duration > 0.1) {
                    // Add subtle vibrato for longer notes
                    oscillator.frequency.setValueAtTime(layer.freq * 1.02, audioContext.currentTime + layer.startTime + layer.duration * 0.3);
                    oscillator.frequency.setValueAtTime(layer.freq * 0.98, audioContext.currentTime + layer.startTime + layer.duration * 0.6);
                    oscillator.frequency.setValueAtTime(layer.freq, audioContext.currentTime + layer.startTime + layer.duration * 0.9);
                }
                
                // Set volume envelope for more natural sound
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + layer.startTime);
                gainNode.gain.linearRampToValueAtTime(layer.volume, audioContext.currentTime + layer.startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(layer.volume * 0.7, audioContext.currentTime + layer.startTime + layer.duration * 0.7);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + layer.startTime + layer.duration);
                
                oscillator.start(audioContext.currentTime + layer.startTime);
                oscillator.stop(audioContext.currentTime + layer.startTime + layer.duration);
            });
        }

        // Dashboard Variables
        let currentDashboardTab = 'users';
        let dashboardData = {
            users: [],
            material: [],
            quiz: [],
            game: [],
            management: []
        };
        let dashboardRefreshInterval = null;

        // Dashboard Functions
        function showDashboardTab(tabName) {
            console.log('Switching to dashboard tab:', tabName);
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active', 'bg-gradient-to-r', 'from-blue-500', 'to-indigo-500');
                tab.classList.add('bg-white/20', 'hover:bg-white/30');
            });
            
            // Activate current tab
            const activeTab = event.target;
            activeTab.classList.remove('bg-white/20', 'hover:bg-white/30');
            activeTab.classList.add('active', 'bg-gradient-to-r', 'from-blue-500', 'to-indigo-500');
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.dashboard-tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            currentDashboardTab = tabName;
            
            // Load data for the selected tab
            loadDashboardData(tabName);
        }

        async function loadDashboardData(tabName = null) {
            const targetTab = tabName || currentDashboardTab;
            console.log('Loading dashboard data for tab:', targetTab);
            
            try {
                // Show loading state
                showLoadingState(targetTab);
                
                // Fetch data from Google Apps Script
                const response = await fetch(`${DASHBOARD_SCRIPT_URL}?action=getData&tab=${targetTab}`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dashboard data received:', data);
                
                // Update dashboard data
                dashboardData[targetTab] = data.data || [];
                
                // Render the data
                renderDashboardData(targetTab, data.data || []);
                
                // Update last update time
                updateLastUpdateTime(targetTab);
                
                // Update total users count if on users tab
                if (targetTab === 'users') {
                    document.getElementById('totalUsersCount').textContent = data.data ? data.data.length : 0;
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorState(targetTab, error.message);
            }
        }

        function showLoadingState(tabName) {
            const tableBody = document.getElementById(tabName + 'TableBody');
            if (tableBody) {
                const colSpan = getColumnSpan(tabName);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-2">â³</div>
                            <p>Memuat data ${getTabDisplayName(tabName)}...</p>
                        </td>
                    </tr>
                `;
            }
        }

        function showErrorState(tabName, errorMessage) {
            const tableBody = document.getElementById(tabName + 'TableBody');
            if (tableBody) {
                const colSpan = getColumnSpan(tabName);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="border border-gray-300 px-4 py-8 text-center text-red-500">
                            <div class="text-4xl mb-2">âŒ</div>
                            <p>Error memuat data: ${errorMessage}</p>
                            <button class="mt-2 bg-blue-500 text-white px-4 py-2 rounded" onclick="loadDashboardData('${tabName}')">
                                ğŸ”„ Coba Lagi
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function renderDashboardData(tabName, data) {
            const tableBody = document.getElementById(tabName + 'TableBody');
            if (!tableBody) return;
            
            if (!data || data.length === 0) {
                const colSpan = getColumnSpan(tabName);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-2">ğŸ“­</div>
                            <p>Belum ada data ${getTabDisplayName(tabName)}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            switch (tabName) {
                case 'users':
                    data.forEach((user, index) => {
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-4 py-3">${index + 1}</td>
                                <td class="border border-gray-300 px-4 py-3 font-semibold">${user.playerName || 'Anonymous'}</td>
                                <td class="border border-gray-300 px-4 py-3">${user.device || 'Unknown'}</td>
                                <td class="border border-gray-300 px-4 py-3">${formatDateTime(user.timestamp)}</td>
                                <td class="border border-gray-300 px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        ${user.status === 'active' ? 'ğŸŸ¢ Aktif' : 'âšª Selesai'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    break;
                    
                case 'material':
                    data.forEach((item, index) => {
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-4 py-3">${index + 1}</td>
                                <td class="border border-gray-300 px-4 py-3 font-semibold">${item.playerName || 'Anonymous'}</td>
                                <td class="border border-gray-300 px-4 py-3">${getAnswerStatus(item.slide2Answer)}</td>
                                <td class="border border-gray-300 px-4 py-3">${getAnswerStatus(item.slide3Answer)}</td>
                                <td class="border border-gray-300 px-4 py-3">${item.slide4Completed ? 'âœ… Selesai' : 'âŒ Belum'}</td>
                                <td class="border border-gray-300 px-4 py-3">${formatDateTime(item.timestamp)}</td>
                            </tr>
                        `;
                    });
                    break;
                    
                case 'quiz':
                    data.forEach((item, index) => {
                        const percentage = item.totalQuestions > 0 ? Math.round((item.correctAnswers / item.totalQuestions) * 100) : 0;
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-4 py-3">${index + 1}</td>
                                <td class="border border-gray-300 px-4 py-3 font-semibold">${item.playerName || 'Anonymous'}</td>
                                <td class="border border-gray-300 px-4 py-3 font-bold text-blue-600">${item.finalScore || 0}</td>
                                <td class="border border-gray-300 px-4 py-3 text-green-600">${item.correctAnswers || 0}</td>
                                <td class="border border-gray-300 px-4 py-3 text-red-600">${item.wrongAnswers || 0}</td>
                                <td class="border border-gray-300 px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${getPercentageColor(percentage)}">
                                        ${percentage}%
                                    </span>
                                </td>
                                <td class="border border-gray-300 px-4 py-3">${formatDateTime(item.timestamp)}</td>
                            </tr>
                        `;
                    });
                    break;
                    
                case 'game':
                    data.forEach((item, index) => {
                        const duration = formatGameDuration(item.timeSeconds);
                        const rating = getGameRating(item.timeSeconds);
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-4 py-3">${index + 1}</td>
                                <td class="border border-gray-300 px-4 py-3 font-semibold">${item.playerName || 'Anonymous'}</td>
                                <td class="border border-gray-300 px-4 py-3 font-bold text-purple-600">${duration}</td>
                                <td class="border border-gray-300 px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                                        âœ… Selesai
                                    </span>
                                </td>
                                <td class="border border-gray-300 px-4 py-3">${rating}</td>
                                <td class="border border-gray-300 px-4 py-3">${formatDateTime(item.timestamp)}</td>
                            </tr>
                        `;
                    });
                    break;
                    
                case 'management':
                    // Update summary cards first
                    updateSummaryCards(data);
                    
                    data.forEach((item, index) => {
                        const materialStatus = `${item.slide2 ? 'âœ…' : 'âŒ'}/${item.slide3 ? 'âœ…' : 'âŒ'}/${item.slide4 ? 'âœ…' : 'âŒ'}`;
                        const quizScore = item.quizScore || 0;
                        const quizPercentage = item.quizPercentage || 0;
                        const gameTime = item.gameTime ? formatGameDuration(item.gameTime) : '-';
                        
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-3 py-2">${index + 1}</td>
                                <td class="border border-gray-300 px-3 py-2 font-semibold">${item.playerName || 'Anonymous'}</td>
                                <td class="border border-gray-300 px-3 py-2 text-center">${materialStatus}</td>
                                <td class="border border-gray-300 px-3 py-2 text-center font-bold text-blue-600">${quizScore}</td>
                                <td class="border border-gray-300 px-3 py-2 text-center">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${getPercentageColor(quizPercentage)}">
                                        ${quizPercentage}%
                                    </span>
                                </td>
                                <td class="border border-gray-300 px-3 py-2 text-center">${gameTime}</td>
                                <td class="border border-gray-300 px-3 py-2">${formatDateTime(item.lastActive)}</td>
                            </tr>
                        `;
                    });
                    break;
            }
            
            tableBody.innerHTML = html;
        }

        function updateSummaryCards(data) {
            const totalUsers = data.length;
            const completedMaterial = data.filter(item => item.slide2 && item.slide3 && item.slide4).length;
            const completedQuiz = data.filter(item => item.quizScore > 0).length;
            const completedGame = data.filter(item => item.gameTime > 0).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('completedMaterial').textContent = completedMaterial;
            document.getElementById('completedQuiz').textContent = completedQuiz;
            document.getElementById('completedGame').textContent = completedGame;
        }

        function getColumnSpan(tabName) {
            const columnCounts = {
                users: 5,
                material: 6,
                quiz: 7,
                game: 6,
                management: 7
            };
            return columnCounts[tabName] || 5;
        }

        function getTabDisplayName(tabName) {
            const displayNames = {
                users: 'user',
                material: 'materi',
                quiz: 'quiz',
                game: 'game',
                management: 'manajemen'
            };
            return displayNames[tabName] || tabName;
        }

        function getAnswerStatus(answer) {
            if (!answer) return 'âŒ Belum';
            return answer === 'sama' ? 'âœ… Benar' : 'âŒ Salah';
        }

        function getPercentageColor(percentage) {
            if (percentage >= 80) return 'bg-green-100 text-green-800';
            if (percentage >= 60) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function formatGameDuration(seconds) {
            if (!seconds) return '-';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function getGameRating(seconds) {
            if (!seconds) return '-';
            if (seconds <= 60) return 'ğŸ† Luar Biasa';
            if (seconds <= 120) return 'â­ Bagus';
            if (seconds <= 180) return 'ğŸ‘ Baik';
            return 'ğŸ’ª Cukup';
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateLastUpdateTime(tabName) {
            const updateElement = document.getElementById(tabName + 'LastUpdate');
            if (updateElement) {
                const now = new Date();
                updateElement.textContent = `Terakhir update: ${now.toLocaleTimeString('id-ID')}`;
            }
        }

        function refreshDashboardData() {
            console.log('Refreshing dashboard data...');
            loadDashboardData(currentDashboardTab);
            
            // Show refresh feedback
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = 'â³ Memuat...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }, 2000);
        }

        async function exportToCSV() {
            try {
                console.log('Exporting data to CSV...');
                
                // Show loading state
                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = 'â³ Mengunduh...';
                exportBtn.disabled = true;
                
                // Fetch comprehensive data
                const response = await fetch(`${DASHBOARD_SCRIPT_URL}?action=exportCSV`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.csvData) {
                    // Create and download CSV file
                    const csvContent = data.csvData;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `ethnomath_data_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Show success message
                        showNotification('âœ… Data berhasil diunduh!', 'success');
                    }
                } else {
                    throw new Error(data.error || 'Failed to export data');
                }
                
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showNotification('âŒ Gagal mengunduh data: ' + error.message, 'error');
            } finally {
                // Restore button
                const exportBtn = document.querySelector('[onclick="exportToCSV()"]');
                if (exportBtn) {
                    exportBtn.innerHTML = 'ğŸ“¥ Download CSV';
                    exportBtn.disabled = false;
                }
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg font-bold text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 5000);
        }

        // Auto-refresh dashboard data every 30 seconds when on dashboard page
        function startDashboardAutoRefresh() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
            }
            
            dashboardRefreshInterval = setInterval(() => {
                const currentPage = document.getElementById('hostDashboardPage');
                if (currentPage && !currentPage.classList.contains('hidden')) {
                    loadDashboardData(currentDashboardTab);
                }
            }, 30000); // 30 seconds
        }

        function stopDashboardAutoRefresh() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
        }

        // Enhanced Audio Management
        let audioInitialized = false;
        
        function initializeAudio() {
            if (audioInitialized) return;
            
            const backgroundMusic = document.getElementById('backgroundMusic');
            if (backgroundMusic) {
                backgroundMusic.volume = 0.3; // Set volume to 30%
                backgroundMusic.play().then(() => {
                    isAudioPlaying = true;
                    audioInitialized = true;
                    const audioIcon = document.getElementById('audioIcon');
                    if (audioIcon) {
                        audioIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>';
                    }
                    console.log('ğŸµ Background music started successfully!');
                }).catch(e => {
                    console.log('ğŸ”‡ Auto-play blocked by browser:', e);
                    // Show a subtle notification that user can enable music
                    showMusicEnableNotification();
                });
            }
        }
        
        function showMusicEnableNotification() {
            // Create a subtle notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-24 right-4 z-40 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-3 rounded-lg shadow-lg text-sm font-semibold animate-bounce';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>ğŸµ</span>
                    <span>Klik tombol musik untuk mengaktifkan suara!</span>
                </div>
            `;
            notification.style.zIndex = '99998';
            
            document.body.appendChild(notification);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.parentElement.removeChild(notification);
                        }
                    }, 500);
                }
            }, 5000);
        }
        
        // Try to initialize audio on first user interaction
        function enableAudioOnInteraction() {
            if (!audioInitialized) {
                initializeAudio();
            }
        }
        
        // Auto-start background music when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ETHNOMATH App loaded successfully!');
            
            // Try immediate autoplay
            setTimeout(() => {
                initializeAudio();
            }, 1000);
            
            // Add event listeners for first user interaction
            const interactionEvents = ['click', 'touchstart', 'keydown'];
            interactionEvents.forEach(event => {
                document.addEventListener(event, enableAudioOnInteraction, { once: true });
            });
        });
    
function sendToGoogleSheets(action, data = {}) {
    try {
        const appsActionMap = {
            'quiz_complete': 'submitQuiz',
            'quiz_answer': null,
            'quiz_start': null,
            'slide2_answer': 'submitMaterial',
            'slide3_answer': 'submitMaterial',
            'slide4_answer': 'submitMaterial',
            'material_start': null,
            'memory_game_complete': 'submitMemory',
            'memory_game_start': null
        };

        const base = {
            action: action,
            sessionId: typeof sessionId !== 'undefined' ? sessionId : '',
            playerName: typeof playerName !== 'undefined' ? playerName : 'Anonymous',
            device: typeof userDevice !== 'undefined' ? userDevice : '',
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            ...data
        };

        const mapped = appsActionMap[action];
        let finalPayload = base;

        if (mapped === 'submitQuiz') {
            finalPayload = {
                action: 'submitQuiz',
                name: base.playerName,
                score: data.finalScore || data.score || 0,
                answers: JSON.stringify(data.answers || data.quizAnswers || []),
                timeSeconds: data.timeUsed || data.timeSeconds || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMaterial') {
            finalPayload = {
                action: 'submitMaterial',
                name: base.playerName,
                slide: data.slide || data.slideNumber || '',
                answer: data.answer || data.answerText || '',
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMemory') {
            finalPayload = {
                action: 'submitMemory',
                name: base.playerName,
                time: data.time || data.timeString || '',
                timeSeconds: data.timeSeconds || data.timeSecondsPlayed || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        }

        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalPayload)
        })
        .catch(err => {
            const params = new URLSearchParams(finalPayload).toString();
            new Image().src = `${APPS_SCRIPT_URL}?${params}`;
        });

    } catch (err) {
        console.error('sendToGoogleSheets error:', err);
    }
}

</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9967f4b0c39afd10',t:'MTc2MTc5NjMwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
function sendToGoogleSheets(action, data = {}) {
    try {
        const appsActionMap = {
            'quiz_complete': 'submitQuiz',
            'quiz_answer': null,
            'quiz_start': null,
            'slide2_answer': 'submitMaterial',
            'slide3_answer': 'submitMaterial',
            'slide4_answer': 'submitMaterial',
            'material_start': null,
            'memory_game_complete': 'submitMemory',
            'memory_game_start': null
        };

        const base = {
            action: action,
            sessionId: typeof sessionId !== 'undefined' ? sessionId : '',
            playerName: typeof playerName !== 'undefined' ? playerName : 'Anonymous',
            device: typeof userDevice !== 'undefined' ? userDevice : '',
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            ...data
        };

        const mapped = appsActionMap[action];
        let finalPayload = base;

        if (mapped === 'submitQuiz') {
            finalPayload = {
                action: 'submitQuiz',
                name: base.playerName,
                score: data.finalScore || data.score || 0,
                answers: JSON.stringify(data.answers || data.quizAnswers || []),
                timeSeconds: data.timeUsed || data.timeSeconds || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMaterial') {
            finalPayload = {
                action: 'submitMaterial',
                name: base.playerName,
                slide: data.slide || data.slideNumber || '',
                answer: data.answer || data.answerText || '',
                timestamp: base.timestamp,
                deviceId: base.device
            };
        } else if (mapped === 'submitMemory') {
            finalPayload = {
                action: 'submitMemory',
                name: base.playerName,
                time: data.time || data.timeString || '',
                timeSeconds: data.timeSeconds || data.timeSecondsPlayed || 0,
                timestamp: base.timestamp,
                deviceId: base.device
            };
        }

        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalPayload)
        })
        .catch(err => {
            const params = new URLSearchParams(finalPayload).toString();
            new Image().src = `${APPS_SCRIPT_URL}?${params}`;
        });

    } catch (err) {
        console.error('sendToGoogleSheets error:', err);
    }
}

</script>
<!-- ====== HOST DASHBOARD: INSERTED BY CHATGPT ====== -->
<!-- Modal + scripts for host dashboard (Semua User, Skor Materi, Skor Quiz, Game Rebana, Manajemen Data) -->
<div id="hostDashboardBackdrop" class="hidden fixed inset-0 flex items-center justify-center dashboard-backdrop z-50 p-4">
  <div class="dashboard-modal bg-white/10 border border-white/20 rounded-2xl p-4 glass-card">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h2 class="text-xl font-bold">Dashboard Host â€” Data Pengguna &amp; Hasil</h2>
        <p class="text-sm text-white/80">Lihat semua pengguna, skor materi, skor quiz, Game Rebana, dan manajemen data.</p>
      </div>
      <div class="flex items-center space-x-2">
        <button id="refreshDashboardBtn" class="px-3 py-1 bg-indigo-600 rounded-md text-white text-sm">Refresh</button>
        <button id="resetDashboardBtn" class="px-3 py-1 bg-orange-500 rounded-md text-white text-sm">Reset Data</button>
        <button id="closeDashboardBtn" class="px-3 py-1 bg-red-500 rounded-md text-white text-sm">Tutup</button>
      </div>
    </div>

    <div class="mb-4">
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn dashboard-tab px-3 py-2 bg-white/10 rounded-full text-sm text-white" data-tab="allUsers">Semua User</button>
        <button class="tab-btn dashboard-tab px-3 py-2 bg-white/10 rounded-full text-sm text-white" data-tab="materi">Skor Materi</button>
        <button class="tab-btn dashboard-tab px-3 py-2 bg-white/10 rounded-full text-sm text-white" data-tab="quiz">Skor Quiz</button>
        <button class="tab-btn dashboard-tab px-3 py-2 bg-white/10 rounded-full text-sm text-white" data-tab="memory">Game Rebana</button>
        <button class="tab-btn dashboard-tab px-3 py-2 bg-white/10 rounded-full text-sm text-white" data-tab="management">Manajemen Data</button>
      </div>
    </div>

    <div class="flex items-center justify-between mb-3">
      <div id="dashboardStatus" class="text-sm text-white/80">Status: <span id="dashboardStatusText">Idle</span></div>
      <div class="flex items-center gap-2">
        <button id="exportCsvBtn" class="px-3 py-1 bg-emerald-500 rounded-md text-sm text-black">Export CSV</button>
        <select id="autoRefreshSelect" class="text-sm p-1 rounded-md bg-white/10">
          <option value="0">Auto refresh: Off</option>
          <option value="15">15s</option>
          <option value="30" selected>30s</option>
          <option value="60">60s</option>
        </select>
      </div>
    </div>

    <div id="dashboardMessages" class="mb-3 text-sm"></div>

    <div id="tabContents">
      <div id="tab_allUsers" class="tab-content hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold">Semua User</h3>
          <div class="text-xs text-white/80">Menampilkan data gabungan dan status (Sedang bermain / Selesai)</div>
        </div>
        <div class="table-scroll bg-white/5 rounded-lg p-2">
          <table id="table_allUsers" class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-xs text-white/80">
                <th class="p-2">Name</th>
                <th class="p-2">DeviceId</th>
                <th class="p-2">Timestamp</th>
                <th class="p-2">Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab_materi" class="tab-content hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold">Skor Materi (MaterialAnswers)</h3>
          <div class="text-xs text-white/80">Kolom: Name, Slide, Answer, Timestamp, DeviceId</div>
        </div>
        <div class="table-scroll bg-white/5 rounded-lg p-2">
          <table id="table_materi" class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-xs text-white/80">
                <th class="p-2">Name</th>
                <th class="p-2">Slide</th>
                <th class="p-2">Answer</th>
                <th class="p-2">Timestamp</th>
                <th class="p-2">DeviceId</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab_quiz" class="tab-content hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold">Skor Quiz (QuizResults)</h3>
          <div class="text-xs text-white/80">Kolom: Name, Score, Answers, Time, Timestamp, DeviceId</div>
        </div>
        <div class="table-scroll bg-white/5 rounded-lg p-2">
          <table id="table_quiz" class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-xs text-white/80">
                <th class="p-2">Name</th>
                <th class="p-2">Score</th>
                <th class="p-2">Answers</th>
                <th class="p-2">Time</th>
                <th class="p-2">Timestamp</th>
                <th class="p-2">DeviceId</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab_memory" class="tab-content hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold">Game Rebana (MemoryResults)</h3>
          <div class="text-xs text-white/80">Kolom: Name, Time, TimeSeconds, Timestamp, DeviceId</div>
        </div>
        <div class="table-scroll bg-white/5 rounded-lg p-2">
          <table id="table_memory" class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-xs text-white/80">
                <th class="p-2">Name</th>
                <th class="p-2">Time</th>
                <th class="p-2">TimeSeconds</th>
                <th class="p-2">Timestamp</th>
                <th class="p-2">DeviceId</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab_management" class="tab-content hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold">Manajemen Data (DataUser / Rekap Gabungan)</h3>
          <div class="text-xs text-white/80">Kolom: Name, MaterialAnswers, QuizResults, MemoryResults, DeviceId, Timestamp</div>
        </div>
        <div class="table-scroll bg-white/5 rounded-lg p-2">
          <table id="table_management" class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-xs text-white/80">
                <th class="p-2">Name</th>
                <th class="p-2">MaterialAnswers</th>
                <th class="p-2">QuizResults</th>
                <th class="p-2">MemoryResults</th>
                <th class="p-2">DeviceId</th>
                <th class="p-2">Timestamp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="mt-4 text-xs text-white/70">Console logs: buka DevTools â†’ Console untuk melihat log sukses/gagal fetch.</div>
  </div>
</div>

<style>
/* minimal styles for injected modal */
.dashboard-backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); }
.dashboard-modal { max-width: 1100px; width: 95%; max-height: 90vh; overflow: auto; }
.table-scroll { max-height: 55vh; overflow:auto; }
</style>

<script>
// APPS SCRIPT URL - ensure matches your Apps Script URL on page
const APPS_SCRIPT_URL = typeof APPS_SCRIPT_URL !== 'undefined' ? APPS_SCRIPT_URL : 'https://script.google.com/macros/s/AKfycbwue0iVG__OH28-7SXJURqplDQz63LcaZYL_ew0jkntkTnGt_WJAhgSQvC5cBW2Dsn3_w/exec';

function parseGASTimestamp(tsStr) {
  if (!tsStr || typeof tsStr !== 'string') return null;
  const parts = tsStr.split(' ');
  if (parts.length < 2) return null;
  const datePart = parts[0].split('/');
  const timePart = parts[1].split(':');
  if (datePart.length !== 3) return null;
  const day = parseInt(datePart[0],10);
  const month = parseInt(datePart[1],10)-1;
  const year = parseInt(datePart[2],10);
  const hour = parseInt(timePart[0],10)||0;
  const min = parseInt(timePart[1],10)||0;
  const sec = parseInt(timePart[2],10)||0;
  return new Date(year, month, day, hour, min, sec);
}

function computeStatusFromTimestamp(tsStr, thresholdMinutes=5) {
  const d = parseGASTimestamp(tsStr);
  if (!d) return 'Unknown';
  const diff = Date.now() - d.getTime();
  return diff <= thresholdMinutes*60*1000 ? 'Sedang bermain' : 'Selesai';
}

function exportToCsv(filename, rows) {
  if (!rows || !rows.length) { alert('Tidak ada data untuk di-export'); return; }
  const keys = Object.keys(rows[0]);
  const csv = [ keys.join(','), ...rows.map(r=>keys.map(k=>`"${String(r[k]===null||r[k]===undefined?'':r[k]).replace(/"/g,'""')}"`).join(',')) ].join('
');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

async function fetchSheet(tabName) {
  const url = APPS_SCRIPT_URL + '?action=getData&tab=' + encodeURIComponent(tabName);
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
  const json = await res.json();
  return Array.isArray(json)?json:[];
}

function renderTable(tableEl, rows, columns) {
  const tbody = tableEl.querySelector('tbody');
  tbody.innerHTML = '';
  if (!rows || !rows.length) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2 text-sm text-white/60" colspan="${columns.length}">Belum ada data.</td>`;
    tbody.appendChild(tr);
    return;
  }
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.className = 'border-b border-white/10';
    tr.innerHTML = columns.map(col=>{
      const val = (r[col]!==undefined && r[col]!==null && r[col]!=='')?r[col]:'-';
      const safe = String(val).replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<td class="p-2 align-top text-sm text-white/90">${safe}</td>`;
    }).join('');
    tbody.appendChild(tr);
  });
}

async function loadAllTabs() {
  setDashboardStatus('Loading...');
  showMessage('Memuat data...');
  try {
    const [material,quiz,memory,management] = await Promise.all([ fetchSheet('MaterialAnswers'), fetchSheet('QuizResults'), fetchSheet('MemoryResults'), fetchSheet('DataUser') ]);
    console.log('Fetched sheets:', {materialLen:material.length, quizLen:quiz.length, memoryLen:memory.length, managementLen:management.length});

    renderTable(document.getElementById('table_materi'), material, ['Name','Slide','Answer','Timestamp','DeviceId']);
    renderTable(document.getElementById('table_quiz'), quiz, ['Name','Score','Answers','Time','Timestamp','DeviceId']);
    renderTable(document.getElementById('table_memory'), memory, ['Name','Time','TimeSeconds','Timestamp','DeviceId']);
    renderTable(document.getElementById('table_management'), management, ['Name','MaterialAnswers','QuizResults','MemoryResults','DeviceId','Timestamp']);

    let allUsersRows = [];
    if (management && management.length) {
      allUsersRows = management.map(r=>({ Name: r.Name||'-', DeviceId: r.DeviceId||'-', Timestamp: r.Timestamp||'-', Status: computeStatusFromTimestamp(r.Timestamp||'') }));
    } else {
      const byKey = {};
      [material,quiz,memory].forEach(arr=>arr.forEach(o=>{
        const name = o.Name||'Anon';
        const dev = o.DeviceId||o.device||o.deviceId||'';
        const ts = o.Timestamp||o.timestamp||'';
        const key = `${name}|${dev}`;
        if (!byKey[key]) byKey[key] = { Name: name, DeviceId: dev, Timestamp: ts };
        else {
          const prev = parseGASTimestamp(byKey[key].Timestamp);
          const cur = parseGASTimestamp(ts);
          if (cur && (!prev || cur.getTime() > prev.getTime())) byKey[key].Timestamp = ts;
        }
      }));
      allUsersRows = Object.values(byKey).map(u=>({ Name: u.Name, DeviceId: u.DeviceId, Timestamp: u.Timestamp, Status: computeStatusFromTimestamp(u.Timestamp||'') }));
    }
    renderTable(document.getElementById('table_allUsers'), allUsersRows, ['Name','DeviceId','Timestamp','Status']);
    setDashboardStatus('Loaded');
    showMessage('Data berhasil dimuat (lihat console untuk detail).', 'success');
    console.log('âœ… Dashboard data loaded.');
    return {material,quiz,memory,management,allUsersRows};
  } catch (err) {
    console.error('âŒ Error loading dashboard:', err);
    setDashboardStatus('Error');
    showMessage('Gagal memuat data: ' + (err.message || err.toString()), 'error');
    throw err;
  }
}

function setDashboardStatus(text){ const el=document.getElementById('dashboardStatusText'); if(el) el.textContent=text; }
function showMessage(msg,type='info'){ const el=document.getElementById('dashboardMessages'); if(!el) return; const color = type==='error'?'text-red-400':type==='success'?'text-green-400':'text-white/80'; el.innerHTML = `<div class="${color}">${msg}</div>`; }

function activateTab(name){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.add('hidden'));
  document.querySelectorAll('.dashboard-tab').forEach(b=>b.classList.remove('active','bg-white/20','text-black'));
  const btn = Array.from(document.querySelectorAll('.dashboard-tab')).find(b=>b.dataset.tab===name);
  if(btn) btn.classList.add('active','bg-white/20','text-black');
  const c = document.getElementById('tab_'+name);
  if(c) c.classList.remove('hidden');
}

let autoRefreshTimer = null;
function setAutoRefresh(seconds){ if(autoRefreshTimer){ clearInterval(autoRefreshTimer); autoRefreshTimer=null; } const s = Number(seconds); if(s>0){ autoRefreshTimer = setInterval(()=>{ console.log('Auto-refresh: loading data...'); loadAllTabs().catch(e=>console.error(e)); }, s*1000); } }

async function exportCurrentTabCsv(){
  try{
    const active = Array.from(document.querySelectorAll('.dashboard-tab')).find(b=>b.classList.contains('active'));
    const tab = active?active.dataset.tab:'allUsers';
    setDashboardStatus('Exporting CSV...'); showMessage('Mempersiapkan CSV...');
    if(tab==='materi'){ const data = await fetchSheet('MaterialAnswers'); exportToCsv('MaterialAnswers.csv', data); }
    else if(tab==='quiz'){ const data = await fetchSheet('QuizResults'); exportToCsv('QuizResults.csv', data); }
    else if(tab==='memory'){ const data = await fetchSheet('MemoryResults'); exportToCsv('MemoryResults.csv', data); }
    else if(tab==='management'){ const data = await fetchSheet('DataUser'); exportToCsv('DataUser.csv', data); }
    else {
      const data = await fetchSheet('DataUser');
      if(data && data.length){ const rows = data.map(r=>({ Name: r.Name, DeviceId: r.DeviceId, Timestamp: r.Timestamp, Status: computeStatusFromTimestamp(r.Timestamp) })); exportToCsv('AllUsers.csv', rows); }
      else {
        const [material,quiz,memory] = await Promise.all([ fetchSheet('MaterialAnswers'), fetchSheet('QuizResults'), fetchSheet('MemoryResults') ]);
        const rows = [ ...material.map(r=>({ Source:'MaterialAnswers', Name:r.Name, DeviceId:r.DeviceId, Timestamp:r.Timestamp })), ...quiz.map(r=>({ Source:'QuizResults', Name:r.Name, DeviceId:r.DeviceId, Timestamp:r.Timestamp })), ...memory.map(r=>({ Source:'MemoryResults', Name:r.Name, DeviceId:r.DeviceId, Timestamp:r.Timestamp })) ];
        exportToCsv('AllUsers_Merged.csv', rows);
      }
    }
    setDashboardStatus('Exported'); showMessage('CSV berhasil dibuat.', 'success');
  } catch(err){
    console.error('Export CSV error:', err); setDashboardStatus('Error'); showMessage('Gagal export CSV: ' + (err.message || err.toString()), 'error');
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.dashboard-tab').forEach(b=>{ b.addEventListener('click', ()=>{ activateTab(b.dataset.tab); }); });
  activateTab('allUsers');
  const hostBtn = document.getElementById('hostLoginBtn');
  const backdrop = document.getElementById('hostDashboardBackdrop');
  const closeBtn = document.getElementById('closeDashboardBtn');
  const refreshBtn = document.getElementById('refreshDashboardBtn');
  const exportBtn = document.getElementById('exportCsvBtn');
  hostBtn && hostBtn.addEventListener('click', async ()=>{ backdrop.classList.remove('hidden'); try{ await loadAllTabs(); }catch(e){ console.error(e); } });
  closeBtn && closeBtn.addEventListener('click', ()=>{ backdrop.classList.add('hidden'); });
  refreshBtn && refreshBtn.addEventListener('click', async ()=>{ try{ await loadAllTabs(); }catch(e){ console.error(e); } });
  exportBtn && exportBtn.addEventListener('click', exportCurrentTabCsv);
  const autoSelect = document.getElementById('autoRefreshSelect');
  autoSelect && autoSelect.addEventListener('change', ()=>{ setAutoRefresh(Number(autoSelect.value)); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') backdrop.classList.add('hidden'); });
  setAutoRefresh(Number((document.getElementById('autoRefreshSelect')||{}).value||0));
});
</script>
<!-- ====== END HOST DASHBOARD INSERT ====== -->

<script>
// ======== PERBAIKAN KONEKSI ETHNOMATH (Sinkron dengan Code.gs terbaru) ========
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwue0iVG__OH28-7SXJURqplDQz63LcaZYL_ew0jkntkTnGt_WJAhgSQvC5cBW2Dsn3_w/exec";


  try {
    const body = { action, timestamp: new Date().toISOString(), ...data };
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const json = await res.json();
    console.log('âœ… Data terkirim:', json);
    return json;
  } catch (err) {
    console.error('âŒ Gagal kirim:', err);
    return { error: err.message };
  }
}

function formatTimestamp(ts) {
  try {
    const d = ts ? new Date(ts) : new Date();
    return d.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
  } catch (e) {
    return new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
  }
}
</script>


<script>
/* ETHNOMATH â€” Robust sender & dashboard v2
   Ensures payload fields match Apps Script handlers and dashboard reads DataUser.
*/
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwue0iVG__OH28-7SXJURqplDQz63LcaZYL_ew0jkntkTnGt_WJAhgSQvC5cBW2Dsn3_w/exec";

// Robust mapper: accepts many action names from original app and normalizes payload
function sendToGoogleSheets(action, data = {}) {
  // Tambahkan timestamp otomatis
  const params = { action, timestamp: new Date().toISOString(), ...data };

  // Ubah data jadi query string
  const qs = new URLSearchParams(params).toString();

  // Buat callback unik (agar JSONP bisa jalan)
  const callbackName = "jsonp_cb_" + Math.random().toString(36).substring(2);
  window[callbackName] = (res) => {
    console.log("âœ… Data terkirim:", res);
    delete window[callbackName];
  };

  // Kirim lewat <script> â€” cara JSONP, tidak diblokir CORS
  const script = document.createElement("script");
  script.src = `${APPS_SCRIPT_URL}?${qs}&callback=${callbackName}`;
  document.body.appendChild(script);
}


// Dashboard helpers (if host panel exists)
async function fetchSheet(tab) {
  try {
    const res = await fetch(`${APPS_SCRIPT_URL}?action=getData&tab=${encodeURIComponent(tab)}`);
    const json = await res.json();
    return Array.isArray(json) ? json : [];
  } catch (e) {
    console.error('fetchSheet error', e);
    return [];
  }
}

function formatTimestampDisplay(val) {
  if (!val) return '';
  // Try to parse ISO or dd/MM/yyyy etc
  const d = new Date(val);
  if (!isNaN(d)) {
    // format dd/MM/yyyy HH:mm:ss in Asia/Jakarta
    try {
      return new Intl.DateTimeFormat('id-ID', {
        timeZone: 'Asia/Jakarta',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      }).format(d);
    } catch (e) {
      return d.toLocaleString();
    }
  }
  return val;
}

function renderTableInto(headEl, bodyEl, data) {
  headEl.innerHTML = '';
  bodyEl.innerHTML = '';
  if (!data || !data.length) {
    headEl.innerHTML = '<tr><th>No data</th></tr>';
    bodyEl.innerHTML = '<tr><td>Tidak ada entri</td></tr>';
    return;
  }
  const headers = Object.keys(data[0]);
  const trh = document.createElement('tr');
  headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      // simple sort
      const asc = th.dataset.asc !== 'true';
      data.sort((a,b) => {
        const A = (a[h]===null||a[h]===undefined)?'':a[h];
        const B = (b[h]===null||b[h]===undefined)?'':b[h];
        if (!isNaN(Number(A)) && !isNaN(Number(B))) return asc ? Number(A)-Number(B) : Number(B)-Number(A);
        return asc ? String(A).localeCompare(String(B)) : String(B).localeCompare(String(A));
      });
      th.dataset.asc = asc;
      renderTableInto(headEl, bodyEl, data);
    });
    trh.appendChild(th);
  });
  headEl.appendChild(trh);

  data.forEach(row => {
    const tr = document.createElement('tr');
    headers.forEach(h => {
      const td = document.createElement('td');
      let v = row[h];
      // format likely timestamp columns
      if (/timestamp|time/i.test(h) && typeof v === 'string') {
        v = formatTimestampDisplay(v);
      }
      // For arrays or JSON strings, normalize
      if (Array.isArray(v)) v = v.join(' ; ');
      if (typeof v === 'string' && v.startsWith('[') && v.endsWith(']')) {
        try { const parsed = JSON.parse(v); if (Array.isArray(parsed)) v = parsed.join(' ; '); } catch(e){}
      }
      td.textContent = v===null||v===undefined?'':v;
      tr.appendChild(td);
    });
    bodyEl.appendChild(tr);
  });
}

// If host panel exists, wire it to use these helpers
document.addEventListener('DOMContentLoaded', () => {
  // try to find various host panel IDs used earlier
  const hostPanel = document.getElementById('hostPanel') || document.querySelector('.host-panel') || null;
  if (!hostPanel) return;
  window.__ethno_host_opened = true;

  const headEl = document.getElementById('hostTableHead') || document.getElementById('tableHead') || hostPanel.querySelector('thead') || null;
  const bodyEl = document.getElementById('hostTableBody') || document.getElementById('tableBody') || hostPanel.querySelector('tbody') || null;

  // define loadHostTab if not present
  window.loadHostTab = window.loadHostTab || async function(tab='DataUser') {
    if (!headEl || !bodyEl) return;
    const data = await fetchSheet(tab);
    // If DataUser is empty, try rebuildRecap trigger by calling getSummary or a rebuild endpoint? We'll just render what we have.
    renderTableInto(headEl, bodyEl, data);
    // update last loaded timestamps if exists
    const lastLoaded = document.getElementById('hostLastLoaded') || document.getElementById('lastLoaded');
    if (lastLoaded) lastLoaded.textContent = new Date().toLocaleString('id-ID', {timeZone:'Asia/Jakarta'});
  };

  // hook existing host buttons if present
  const hostBtn = document.getElementById('hostLoginBtn') || document.querySelector('[data-host-btn]') || null;
  if (hostBtn) hostBtn.addEventListener('click', (e) => {
    // show host panel
    hostPanel.classList.remove('hidden');
    hostPanel.style.display = 'block';
    loadHostTab('DataUser');
  });

  // wire close/refresh/reset if present
  const closeBtn = document.getElementById('hostClose') || document.getElementById('closeHostBtn') || hostPanel.querySelector('.host-close') || null;
  if (closeBtn) closeBtn.addEventListener('click', () => { hostPanel.classList.add('hidden'); });

  const refreshBtn = document.getElementById('refreshHostBtn') || document.getElementById('refreshBtn') || hostPanel.querySelector('#refreshHostBtn') || null;
  if (refreshBtn) refreshBtn.addEventListener('click', () => loadHostTab('DataUser'));

  const resetBtn = document.getElementById('resetHostBtn') || document.getElementById('resetBtn') || hostPanel.querySelector('#resetHostBtn') || null;
  if (resetBtn) resetBtn.addEventListener('click', async () => {
    if (!confirm('âš ï¸ Yakin ingin menghapus SEMUA data di Google Sheets?')) return;
    try {
      const r = await fetch(`${APPS_SCRIPT_URL}?action=resetData`);
      const j = await r.json();
      alert(j.msg || j.error || 'Reset OK');
      loadHostTab('DataUser');
    } catch (e) { alert('Reset gagal: '+e.message); }
  });

  // tabs inside host panel
  const tabButtons = hostPanel.querySelectorAll('#hostTabs .tab, .tabs .tab');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', (ev) => {
      const tab = btn.dataset.tab || btn.getAttribute('data-tab');
      if (!tab) return;
      // mark active
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadHostTab(tab);
    });
  });
});
</script>

</body>
</html>
